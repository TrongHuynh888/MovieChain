/**
 * ============================================
 * APP.JS - R·∫°p Chi·∫øu Phim Blockchain
 * ============================================
 * Main application logic
 * Bao g·ªìm: Authentication, CRUD, Web3 Payment, UI Logic
 */

// ============================================
// GLOBAL STATE
// ============================================
let currentUser = null; // User hi·ªán t·∫°i ƒëang ƒëƒÉng nh·∫≠p
let isAdmin = false; // C√≥ ph·∫£i Admin kh√¥ng
let currentMovieId = null; // ID phim ƒëang xem chi ti·∫øt
let currentEpisode = 0; // T·∫≠p phim ƒëang xem
let selectedRating = 0; // ƒê√°nh gi√° ƒë√£ ch·ªçn
let allMovies = []; // Cache danh s√°ch phim
let allCategories = []; // Cache danh s√°ch th·ªÉ lo·∫°i
let allCountries = []; // Cache danh s√°ch qu·ªëc gia
let editingUserId = null; // ID user ƒëang ch·ªânh s·ª≠a role

// ============================================
// SAMPLE DATA (D·ªØ li·ªáu m·∫´u khi ch∆∞a c√≥ Firebase)
// ============================================
const SAMPLE_CATEGORIES = [
  { id: "action", name: "H√†nh ƒë·ªông", slug: "hanh-dong" },
  { id: "comedy", name: "H√†i h∆∞·ªõc", slug: "hai-huoc" },
  { id: "horror", name: "Kinh d·ªã", slug: "kinh-di" },
  { id: "romance", name: "T√¨nh c·∫£m", slug: "tinh-cam" },
  { id: "scifi", name: "Khoa h·ªçc vi·ªÖn t∆∞·ªüng", slug: "khoa-hoc-vien-tuong" },
  { id: "animation", name: "Ho·∫°t h√¨nh", slug: "hoat-hinh" },
  { id: "drama", name: "Ch√≠nh k·ªãch", slug: "chinh-kich" },
  { id: "thriller", name: "Gi·∫≠t g√¢n", slug: "giat-gan" },
];

const SAMPLE_COUNTRIES = [
  { id: "vn", name: "Vi·ªát Nam", code: "VN" },
  { id: "us", name: "M·ªπ", code: "US" },
  { id: "kr", name: "H√†n Qu·ªëc", code: "KR" },
  { id: "jp", name: "Nh·∫≠t B·∫£n", code: "JP" },
  { id: "cn", name: "Trung Qu·ªëc", code: "CN" },
  { id: "th", name: "Th√°i Lan", code: "TH" },
  { id: "uk", name: "Anh", code: "UK" },
  { id: "fr", name: "Ph√°p", code: "FR" },
];

const SAMPLE_MOVIES = [
  {
    id: "movie1",
    title: "Ng∆∞·ªùi Nh·ªán: Du H√†nh V≈© Tr·ª•",
    posterUrl:
      "https://image.tmdb.org/t/p/w500/8Vt6mWEReuy4Of61Lnj5Xj704m8.jpg",
    description:
      "Miles Morales tr·ªü l·∫°i trong cu·ªôc phi√™u l∆∞u xuy√™n ƒëa v≈© tr·ª•, g·∫∑p g·ª° c√°c phi√™n b·∫£n Ng∆∞·ªùi Nh·ªán t·ª´ nhi·ªÅu th·∫ø gi·ªõi kh√°c nhau.",
    price: 15,
    status: "public",
    category: "Ho·∫°t h√¨nh",
    country: "M·ªπ",
    year: 2023,
    tags: ["hot", "ƒë·ªÅ c·ª≠"],
    views: 15420,
    rating: 9.2,
    episodes: [
      {
        episodeNumber: 1,
        title: "Full Movie",
        youtubeId: "cqGjhVJWtEg",
        duration: "140 ph√∫t",
        quality: "Full HD",
      },
    ],
    createdAt: new Date("2024-01-15"),
  },
  {
    id: "movie2",
    title: "Oppenheimer",
    posterUrl:
      "https://image.tmdb.org/t/p/w500/8Gxv8gSFCU0XGDykEGv7zR1n2ua.jpg",
    description:
      "C√¢u chuy·ªán v·ªÅ J. Robert Oppenheimer v√† vai tr√≤ c·ªßa √¥ng trong vi·ªác ph√°t tri·ªÉn bom nguy√™n t·ª≠.",
    price: 20,
    status: "public",
    category: "Ch√≠nh k·ªãch",
    country: "M·ªπ",
    year: 2023,
    tags: ["hot", "m·ªõi"],
    views: 28350,
    rating: 8.9,
    episodes: [
      {
        episodeNumber: 1,
        title: "Full Movie",
        youtubeId: "uYPbbksJxIg",
        duration: "180 ph√∫t",
        quality: "4K",
      },
    ],
    createdAt: new Date("2024-01-20"),
  },
  {
    id: "movie3",
    title: "Qu·ª∑ Quy·ªát: C·ª≠a ƒê·ªè V√¥ ƒê·ªãnh",
    posterUrl:
      "https://image.tmdb.org/t/p/w500/d5NXSklXo0qyIYkgV94XAgMIckC.jpg",
    description:
      "Josh Lambert ƒë·ªëi m·∫∑t v·ªõi qu√° kh·ª© ƒëen t·ªëi khi anh b∆∞·ªõc v√†o The Further ƒë·ªÉ gi·∫£i c·ª©u con trai.",
    price: 12,
    status: "public",
    category: "Kinh d·ªã",
    country: "M·ªπ",
    year: 2023,
    tags: ["m·ªõi"],
    views: 9870,
    rating: 7.5,
    episodes: [
      {
        episodeNumber: 1,
        title: "Full Movie",
        youtubeId: "FbCN7JrDhkY",
        duration: "107 ph√∫t",
        quality: "Full HD",
      },
    ],
    createdAt: new Date("2024-02-01"),
  },
  {
    id: "movie4",
    title: "H√†nh Tinh C√°t: Ph·∫ßn 2",
    posterUrl:
      "https://image.tmdb.org/t/p/w500/8b8R8l88Qje9dn9OE8PY05Nxl1X.jpg",
    description:
      "Paul Atreides h·ª£p t√°c v·ªõi Chani v√† ng∆∞·ªùi Fremen ƒë·ªÉ tr·∫£ th√π nh·ªØng k·∫ª ƒë√£ h·ªßy ho·∫°i gia ƒë√¨nh anh.",
    price: 25,
    status: "public",
    category: "Khoa h·ªçc vi·ªÖn t∆∞·ªüng",
    country: "M·ªπ",
    year: 2024,
    tags: ["hot", "ƒë·ªÅ c·ª≠", "m·ªõi"],
    views: 45230,
    rating: 9.5,
    episodes: [
      {
        episodeNumber: 1,
        title: "Full Movie",
        youtubeId: "Way9Dexny3w",
        duration: "166 ph√∫t",
        quality: "4K",
      },
    ],
    createdAt: new Date("2024-02-28"),
  },
  {
    id: "movie5",
    title: "Kungfu Panda 4",
    posterUrl:
      "https://image.tmdb.org/t/p/w500/kDp1vUBnMpe8ak4rjgl3cLELqjU.jpg",
    description:
      "Po ph·∫£i ƒë√†o t·∫°o m·ªôt Chi·∫øn binh R·ªìng m·ªõi trong khi ƒë·ªëi m·∫∑t v·ªõi m·ªëi ƒëe d·ªça t·ª´ ph√π th·ªßy Chameleon.",
    price: 10,
    status: "public",
    category: "Ho·∫°t h√¨nh",
    country: "M·ªπ",
    year: 2024,
    tags: ["m·ªõi", "gia ƒë√¨nh"],
    views: 18760,
    rating: 8.2,
    episodes: [
      {
        episodeNumber: 1,
        title: "Full Movie",
        youtubeId: "_inKs4eeHiI",
        duration: "94 ph√∫t",
        quality: "Full HD",
      },
    ],
    createdAt: new Date("2024-03-08"),
  },
  {
    id: "movie6",
    title: "Squid Game: Tr√≤ Ch∆°i Con M·ª±c",
    posterUrl:
      "https://image.tmdb.org/t/p/w500/dDlEmu3EZ0Pgg93K2SVNLCjCSvE.jpg",
    description:
      "H√†ng trƒÉm ng∆∞·ªùi ch∆°i thi·∫øu ti·ªÅn ch·∫•p nh·∫≠n l·ªùi m·ªùi tham gia c√°c tr√≤ ch∆°i tr·∫ª em v·ªõi gi·∫£i th∆∞·ªüng kh·ªïng l·ªì.",
    price: 8,
    status: "public",
    category: "Gi·∫≠t g√¢n",
    country: "H√†n Qu·ªëc",
    year: 2021,
    tags: ["hot", "ƒë·ªÅ c·ª≠"],
    views: 89450,
    rating: 9.0,
    episodes: [
      {
        episodeNumber: 1,
        title: "T·∫≠p 1: ƒê√®n xanh, ƒë√®n ƒë·ªè",
        youtubeId: "oqxAJKy0ii4",
        duration: "60 ph√∫t",
        quality: "Full HD",
      },
      {
        episodeNumber: 2,
        title: "T·∫≠p 2: ƒê·ªãa ng·ª•c",
        youtubeId: "oqxAJKy0ii4",
        duration: "62 ph√∫t",
        quality: "Full HD",
      },
      {
        episodeNumber: 3,
        title: "T·∫≠p 3: Ng∆∞·ªùi gi·ªØ √¥",
        youtubeId: "oqxAJKy0ii4",
        duration: "55 ph√∫t",
        quality: "Full HD",
      },
    ],
    createdAt: new Date("2023-09-17"),
  },
  {
    id: "movie7",
    title: "Mai",
    posterUrl: "/images/Mai.jpg",
    description:
      "C√¢u chuy·ªán v·ªÅ Mai - m·ªôt c√¥ g√°i massage v·ªõi qu√° kh·ª© b√≠ ·∫©n v√† h√†nh tr√¨nh t√¨m ki·∫øm t√¨nh y√™u ƒë√≠ch th·ª±c.",
    price: 10,
    status: "public",
    category: "T√¨nh c·∫£m",
    country: "Vi·ªát Nam",
    year: 2024,
    tags: ["hot", "m·ªõi"],
    views: 125680,
    rating: 8.7,
    episodes: [
      {
        episodeNumber: 1,
        title: "Full Movie",
        youtubeId: "Ql8Gg3kAyYE",
        duration: "131 ph√∫t",
        quality: "Full HD",
      },
    ],
    createdAt: new Date("2024-02-10"),
  },
  {
    id: "movie8",
    title: "Godzilla x Kong: ƒê·∫ø Ch·∫ø M·ªõi",
    posterUrl:
      "https://image.tmdb.org/t/p/w500/z1p34vh7dEOnLDmyCrlUVLuoDzd.jpg",
    description:
      "Hai titan huy·ªÅn tho·∫°i h·ª£p s·ª©c ch·ªëng l·∫°i m·ªëi ƒëe d·ªça ch∆∞a t·ª´ng c√≥ t·ª´ th·∫ø gi·ªõi ng·∫ßm.",
    price: 18,
    status: "public",
    category: "H√†nh ƒë·ªông",
    country: "M·ªπ",
    year: 2024,
    tags: ["hot", "m·ªõi"],
    views: 67890,
    rating: 8.4,
    episodes: [
      {
        episodeNumber: 1,
        title: "Full Movie",
        youtubeId: "lV1OOlGwExM",
        duration: "115 ph√∫t",
        quality: "4K",
      },
    ],
    createdAt: new Date("2024-03-29"),
  },
];

// ============================================
// INITIALIZATION
// ============================================
// ‚úÖ ƒê·ªïi th√†nh h√†m g·∫Øn v√†o window ƒë·ªÉ loader.js g·ªçi ƒë∆∞·ª£c
window.startMovieChainApp = async () => {
  console.log("üé¨ MovieChain - HTML ƒë√£ t·∫£i xong. B·∫Øt ƒë·∫ßu ch·∫°y Logic...");

  // Kh·ªüi t·∫°o Firebase
  const firebaseInitialized = initializeFirebase();

  if (firebaseInitialized) {
    // L·∫Øng nghe tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
    auth.onAuthStateChanged(handleAuthStateChange);
  }

  // Load d·ªØ li·ªáu ban ƒë·∫ßu (s·ª≠ d·ª•ng sample data n·∫øu Firebase ch∆∞a config)
  await loadInitialData();

  // Kh·ªüi t·∫°o UI
  initializeUI();

  // Kh·ªüi t·∫°o rating stars
  initializeRatingStars();

  // Load theme t·ª´ localStorage
  loadTheme();

  // Navbar scroll effect
  initNavbarScroll();

  console.log("‚úÖ ·ª®ng d·ª•ng ƒë√£ s·∫µn s√†ng!");
};

// ============================================
// AUTHENTICATION HANDLERS
// ============================================

/**
 * X·ª≠ l√Ω khi tr·∫°ng th√°i ƒëƒÉng nh·∫≠p thay ƒë·ªïi (ƒê√£ s·ª≠a l·ªói Avatar & updateProfile)
 */
async function handleAuthStateChange(user) {
  // B∆∞·ªõc 1: G√°n user g·ªëc t·ª´ Auth
  currentUser = user;

  if (user) {
    // ============================================================
    // 1. L·∫§Y D·ªÆ LI·ªÜU T·ª™ FIRESTORE & KI·ªÇM TRA VIP
    // ============================================================
    if (db) {
      try {
        // L·∫ßn 1: L·∫•y d·ªØ li·ªáu th√¥ l√™n ƒë·ªÉ ki·ªÉm tra
        const userDoc = await db.collection("users").doc(user.uid).get();

        if (userDoc.exists) {
          const userData = userDoc.data();

          // üëá A. G·ªåI H√ÄM KI·ªÇM TRA H·∫æT H·∫†N NGAY T·∫†I ƒê√ÇY üëá
          // N·∫øu h·∫øt h·∫°n, h√†m n√†y s·∫Ω √¢m th·∫ßm s·ª≠a DB th√†nh Free
          await checkAndDowngradeVip(user, userData);

          // üëá B. L·∫§Y L·∫†I D·ªÆ LI·ªÜU M·ªöI NH·∫§T (QUAN TR·ªåNG) üëá
          // Ph·∫£i l·∫•y l·∫°i l·∫ßn n·ªØa ƒë·ªÉ ƒë·∫£m b·∫£o bi·∫øn 'freshData' ch·ª©a tr·∫°ng th√°i Free (n·∫øu v·ª´a b·ªã h·∫° c·∫•p)
          const freshDoc = await db.collection("users").doc(user.uid).get();
          const freshData = freshDoc.data();

          // üõ°Ô∏è Ki·ªÉm tra kh√≥a t√†i kho·∫£n (D√πng d·ªØ li·ªáu m·ªõi)
          if (freshData.isActive === false) {
            await auth.signOut();
            alert("‚õî T√ÄI KHO·∫¢N C·ª¶A B·∫†N ƒê√É B·ªä KH√ìA!");
            window.location.reload();
            return;
          }

          // üëá C. G√ÅN D·ªÆ LI·ªÜU M·ªöI V√ÄO CURRENT USER üëá
          currentUser.favorites = freshData.favorites || [];
          currentUser.role = freshData.role || "user";
          currentUser.isActive = freshData.isActive;

          currentUser.purchasedMovies = freshData.purchasedMovies || [];
          // G√°n tr·∫°ng th√°i VIP (L√∫c n√†y n·∫øu h·∫øt h·∫°n th√¨ freshData.isVip ƒë√£ l√† false)
          currentUser.isVip = freshData.isVip;
          // üëâ TH√äM D√íNG N√ÄY ƒê·ªÇ L·∫§Y NG√ÄY H·∫æT H·∫†N:
          currentUser.vipExpiresAt = userData.vipExpiresAt;
          if (freshData.avatar) {
            currentUser.photoURL = freshData.avatar;
          }

          isAdmin = freshData.role === "admin";
        }
      } catch (error) {
        console.error("L·ªói l·∫•y d·ªØ li·ªáu user:", error);
      }
    }
    // ============================================================

    console.log("‚úÖ ƒê√£ ƒëƒÉng nh·∫≠p:", user.email);

    // 2. C·∫≠p nh·∫≠t giao di·ªán (Avatar, Vi·ªÅn v√†ng, T√™n...)
    updateAuthUI(true);

    // 3. C·∫≠p nh·∫≠t l·∫ßn ƒëƒÉng nh·∫≠p cu·ªëi
    createOrUpdateUserDoc(user);

    // 4. Load d·ªØ li·ªáu admin n·∫øu c·∫ßn
    if (isAdmin) {
      loadAdminData();
    }

    // 5. V·∫Ω l·∫°i danh s√°ch phim
    renderFeaturedMovies();
    renderNewMovies();
    renderAllMovies();

    // C·∫≠p nh·∫≠t trang chi ti·∫øt n·∫øu ƒëang xem
    if (currentMovieId) {
      const detailLikeBtn = document.querySelector(
        `.btn-like-${currentMovieId}`,
      );
      if (detailLikeBtn) viewMovieDetail(currentMovieId);
      checkAndUpdateVideoAccess();
    }
  } else {
    // --- CH∆ØA ƒêƒÇNG NH·∫¨P ---
    console.log("‚ùå Ch∆∞a ƒëƒÉng nh·∫≠p");
    currentUser = null;
    isAdmin = false;
    updateAuthUI(false);

    renderFeaturedMovies();
    renderNewMovies();
    renderAllMovies();
  }
}
/**
 * Ki·ªÉm tra xem user c√≥ ph·∫£i Admin kh√¥ng
 */
async function checkAdminRole(user) {
  // Ki·ªÉm tra b·∫±ng email
  if (user.email === ADMIN_EMAIL) {
    return true;
  }

  // Ki·ªÉm tra b·∫±ng UID
  if (ADMIN_UID && user.uid === ADMIN_UID) {
    return true;
  }

  // Ki·ªÉm tra trong Firestore
  try {
    const userDoc = await db.collection("users").doc(user.uid).get();
    if (userDoc.exists && userDoc.data().role === "admin") {
      return true;
    }
  } catch (error) {
    console.error("L·ªói ki·ªÉm tra admin role:", error);
  }

  return false;
}

/**
 * T·∫°o ho·∫∑c c·∫≠p nh·∫≠t user document trong Firestore
 */
async function createOrUpdateUserDoc(user) {
  if (!db) return;

  try {
    const userRef = db.collection("users").doc(user.uid);
    const userDoc = await userRef.get();

    if (!userDoc.exists) {
      // T·∫°o m·ªõi user document
      await userRef.set({
        uid: user.uid,
        email: user.email,
        displayName: user.displayName || user.email.split("@")[0],
        avatar: user.photoURL || "",
        role: user.email === ADMIN_EMAIL ? "admin" : "user",
        isActive: true,
        purchasedMovies: [],
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
      });
      console.log("‚úÖ ƒê√£ t·∫°o user document m·ªõi");
    } else {
      // C·∫≠p nh·∫≠t lastLogin
      await userRef.update({
        lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
      });
    }
  } catch (error) {
    console.error("‚ùå L·ªói t·∫°o/c·∫≠p nh·∫≠t user doc:", error);
  }
}

/**
 * C·∫≠p nh·∫≠t UI theo tr·∫°ng th√°i ƒëƒÉng nh·∫≠p (ƒê√£ th√™m logic hi·ªÉn th·ªã VIP)
 */
function updateAuthUI(isLoggedIn) {
  // L·∫•y c√°c ph·∫ßn t·ª≠ giao di·ªán
  const loginBtn = document.getElementById("loginBtn");
  const userMenuTrigger = document.getElementById("userMenuTrigger");
  const userAvatarSmall = document.getElementById("userAvatarSmall");

  const dropdownAvatar = document.getElementById("dropdownAvatar");
  const dropdownName = document.getElementById("dropdownName");

  // üëá L·∫•y th√™m ph·∫ßn t·ª≠ hi·ªÉn th·ªã ch·ªØ "Free/VIP" üëá
  const roleBadge = document.querySelector(".dropdown-role");

  const adminNavLink = document.getElementById("adminNavLink");
  const commentForm = document.getElementById("commentForm");

  if (isLoggedIn && currentUser) {
    // 1. ·∫®n n√∫t ƒëƒÉng nh·∫≠p, hi·ªán Avatar
    if (loginBtn) loginBtn.classList.add("hidden");
    if (userMenuTrigger) userMenuTrigger.classList.remove("hidden");

    // 2. L·∫•y link ·∫£nh
    const avatarUrl =
      currentUser.photoURL ||
      `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName || "User")}&background=random`;

    // 3. C·∫≠p nh·∫≠t ·∫£nh v√† t√™n
    if (userAvatarSmall) userAvatarSmall.src = avatarUrl;
    if (dropdownAvatar) dropdownAvatar.src = avatarUrl;
    if (dropdownName)
      dropdownName.textContent = currentUser.displayName || "User";

    // ============================================================
    // üëá LOGIC M·ªöI: X·ª¨ L√ù GIAO DI·ªÜN VIP üëá
    // ============================================================
    const isVip = currentUser.isVip === true;

    // A. X·ª≠ l√Ω Vi·ªÅn Avatar
    if (isVip) {
      if (userAvatarSmall) userAvatarSmall.classList.add("vip-border");
      if (dropdownAvatar) dropdownAvatar.classList.add("vip-border");
    } else {
      if (userAvatarSmall) userAvatarSmall.classList.remove("vip-border");
      if (dropdownAvatar) dropdownAvatar.classList.remove("vip-border");
    }

    // B. X·ª≠ l√Ω ch·ªØ Free -> VIP k√®m Th·ªùi h·∫°n
    if (roleBadge) {
      if (isVip) {
        // --- T√çNH TO√ÅN TH·ªúI H·∫†N ---
        let durationText = "";

        if (currentUser.vipExpiresAt) {
          // C√≥ ng√†y h·∫øt h·∫°n -> T√≠nh s·ªë ng√†y c√≤n l·∫°i
          // Ki·ªÉm tra xem vipExpiresAt l√† Firestore Timestamp hay Date object
          const expiryDate = currentUser.vipExpiresAt.toDate
            ? currentUser.vipExpiresAt.toDate()
            : new Date(currentUser.vipExpiresAt);
          const now = new Date();
          const diffTime = expiryDate - now;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

          // N·∫øu c√≤n ng√†y th√¨ hi·ªán s·ªë, h·∫øt th√¨ hi·ªán 0
          const daysLeft = diffDays > 0 ? diffDays : 0;
          durationText = `<span style="font-size: 9px; margin-left: 4px; opacity: 0.9;">(${daysLeft} ng√†y)</span>`;
        } else {
          // Kh√¥ng c√≥ ng√†y h·∫øt h·∫°n -> Vƒ©nh vi·ªÖn
          durationText = `<span style="font-size: 10px; margin-left: 4px;">‚ôæÔ∏è</span>`;
        }

        // Hi·ªÉn th·ªã ra HTML
        roleBadge.innerHTML = `<i class="fas fa-crown"></i> VIP ${durationText}`;
        roleBadge.classList.add("vip-badge");
        roleBadge.classList.remove("dropdown-role");
        roleBadge.classList.add("dropdown-role");
      } else {
        // T√†i kho·∫£n th∆∞·ªùng
        if (isAdmin) {
          roleBadge.textContent = "Admin";
          roleBadge.classList.remove("vip-badge");
        } else {
          roleBadge.textContent = "Free";
          roleBadge.classList.remove("vip-badge");
        }
      }
    }
    // ============================================================

    // 4. Hi·ªán link Admin n·∫øu l√† admin
    if (isAdmin && adminNavLink) adminNavLink.classList.remove("hidden");

    // 5. Hi·ªán form b√¨nh lu·∫≠n
    if (commentForm) commentForm.style.display = "block";
  } else {
    // --- CH∆ØA ƒêƒÇNG NH·∫¨P ---
    if (loginBtn) loginBtn.classList.remove("hidden");
    if (userMenuTrigger) userMenuTrigger.classList.add("hidden");

    // Reset vi·ªÅn khi ƒëƒÉng xu·∫•t
    if (userAvatarSmall) userAvatarSmall.classList.remove("vip-border");

    if (adminNavLink) adminNavLink.classList.add("hidden");
    if (commentForm) commentForm.style.display = "none";
  }
}

// üëá TH√äM 2 H√ÄM N√ÄY XU·ªêNG D∆Ø·ªöI H√ÄM updateAuthUI ƒê·ªÇ ƒêI·ªÄU KHI·ªÇN MENU üëá

/**
 * B·∫≠t/t·∫Øt Menu User (ƒê√£ s·ª≠a l·ªói xung ƒë·ªôt click)
 */
function toggleUserDropdown(event) {
  // 1. Ch·∫∑n s·ª± ki·ªán click lan ra ngo√†i (QUAN TR·ªåNG NH·∫§T)
  if (event) {
    event.stopPropagation();
  }

  const dropdown = document.getElementById("userDropdown");
  if (dropdown) {
    dropdown.classList.toggle("active");
  }
}

/**
 * ƒê√≥ng menu khi click ra ngo√†i
 */
document.addEventListener("click", function (event) {
  const dropdown = document.getElementById("userDropdown");
  const trigger = document.getElementById("userMenuTrigger");

  // N·∫øu menu ƒëang m·ªü
  if (dropdown && dropdown.classList.contains("active")) {
    // V√† c√°i click ƒë√≥ KH√îNG n·∫±m trong menu, c≈©ng KH√îNG n·∫±m trong n√∫t Avatar
    if (!dropdown.contains(event.target) && !trigger.contains(event.target)) {
      dropdown.classList.remove("active");
    }
  }
});
/**
 * X·ª≠ l√Ω ƒëƒÉng nh·∫≠p
 */
async function handleLogin(event) {
  event.preventDefault();

  const email = document.getElementById("loginEmail").value;
  const password = document.getElementById("loginPassword").value;

  if (!auth) {
    showNotification(
      "Firebase ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh. Vui l√≤ng ki·ªÉm tra firebase-config.js",
      "error",
    );
    return;
  }

  try {
    showLoading(true, "ƒêang ƒëƒÉng nh·∫≠p...");

    // 1. ƒêƒÉng nh·∫≠p v√†o Firebase Auth
    const userCredential = await auth.signInWithEmailAndPassword(
      email,
      password,
    );
    const user = userCredential.user;

    // üëá 2. TH√äM ƒêO·∫†N KI·ªÇM TRA B·ªä X√ìA NGAY T·∫†I ƒê√ÇY üëá
    const userDoc = await db.collection("users").doc(user.uid).get();

    if (userDoc.exists && userDoc.data().isDeleted === true) {
      // N·∫øu b·ªã x√≥a -> ƒêƒÉng xu·∫•t ngay l·∫≠p t·ª©c
      await auth.signOut();
      throw new Error("account-deleted"); // N√©m l·ªói t·ª± t·∫°o
    }
    showNotification("ƒêƒÉng nh·∫≠p th√†nh c√¥ng!", "success");
    closeModal("authModal");

    // Reset form
    document.getElementById("loginForm").reset();
  } catch (error) {
    console.error("L·ªói ƒëƒÉng nh·∫≠p:", error);
    let errorMessage = "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i!";

    // üëá X·ª¨ L√ù L·ªñI T√ÄI KHO·∫¢N B·ªä X√ìA üëá
    if (error.message === "account-deleted") {
      errorMessage =
        "‚ùå T√†i kho·∫£n n√†y ƒë√£ b·ªã Admin x√≥a vƒ©nh vi·ªÖn! Vui l√≤ng ƒëƒÉng k√Ω t√†i kho·∫£n m·ªõi.";
    }
    // C√°c l·ªói c≈© c·ªßa Firebase
    else
      switch (error.code) {
        case "auth/user-not-found":
          errorMessage = "Email kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng";
          break;
        case "auth/wrong-password":
          errorMessage = "M·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c";
          break;
        case "auth/invalid-email":
          errorMessage = "Email kh√¥ng h·ª£p l·ªá";
          break;
        case "auth/too-many-requests":
          errorMessage = "Qu√° nhi·ªÅu l·∫ßn th·ª≠. Vui l√≤ng th·ª≠ l·∫°i sau";
          break;
      }

    showNotification(errorMessage, "error");
  } finally {
    showLoading(false);
  }
}

/**
 * X·ª≠ l√Ω ƒëƒÉng k√Ω
 */
async function handleRegister(event) {
  event.preventDefault();

  const name = document.getElementById("registerName").value;
  const email = document.getElementById("registerEmail").value;
  const password = document.getElementById("registerPassword").value;
  const confirmPassword = document.getElementById(
    "registerConfirmPassword",
  ).value;
  const avatarUrl =
    document.getElementById("registerAvatar").value ||
    "https://ui-avatars.com/api/?name=" +
      encodeURIComponent(name) +
      "&background=random";
  // Validate
  if (password !== confirmPassword) {
    showNotification("M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!", "error");
    return;
  }

  if (password.length < 6) {
    showNotification("M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!", "error");
    return;
  }

  if (!auth) {
    showNotification(
      "Firebase ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh. Vui l√≤ng ki·ªÉm tra firebase-config.js",
      "error",
    );
    return;
  }

  try {
    showLoading(true, "ƒêang t·∫°o t√†i kho·∫£n...");

    // T·∫°o t√†i kho·∫£n
    const userCredential = await auth.createUserWithEmailAndPassword(
      email,
      password,
    );

    // C·∫≠p nh·∫≠t display name
    await userCredential.user.updateProfile({
      displayName: name,
      photoURL: avatarUrl, // L∆∞u link ·∫£nh v√†o Firebase Auth
    });

    showNotification(
      "ƒêƒÉng k√Ω th√†nh c√¥ng! Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi MovieChain!",
      "success",
    );
    closeModal("authModal");

    // Reset form
    document.getElementById("registerForm").reset();
  } catch (error) {
    console.error("L·ªói ƒëƒÉng k√Ω:", error);
    let errorMessage = "ƒêƒÉng k√Ω th·∫•t b·∫°i!";

    switch (error.code) {
      case "auth/email-already-in-use":
        errorMessage =
          "Email n√†y ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω (ho·∫∑c t√†i kho·∫£n c≈© ƒë√£ b·ªã x√≥a). Vui l√≤ng d√πng Email kh√°c!";
        break;
      case "auth/invalid-email":
        errorMessage = "Email kh√¥ng h·ª£p l·ªá";
        break;
      case "auth/weak-password":
        errorMessage = "M·∫≠t kh·∫©u qu√° y·∫øu";
        break;
    }

    showNotification(errorMessage, "error");
  } finally {
    showLoading(false);
  }
}

/**
 * X·ª≠ l√Ω ƒëƒÉng xu·∫•t
 */
async function handleLogout() {
  if (!auth) return;

  try {
    await auth.signOut();

    // üëá TH√äM ƒêO·∫†N N√ÄY ƒê·ªÇ ƒê√ìNG MENU & RESET GIAO DI·ªÜN üëá
    const dropdown = document.getElementById("userDropdown");
    if (dropdown) dropdown.classList.remove("active"); // ƒê√≥ng menu ngay l·∫≠p t·ª©c

    // ƒê·∫£m b·∫£o n√∫t ƒêƒÉng nh·∫≠p hi·ªán l·∫°i ngay (ph√≤ng h·ªù updateAuthUI ch·∫°y ch·∫≠m)
    const loginBtn = document.getElementById("loginBtn");
    const userMenuTrigger = document.getElementById("userMenuTrigger");
    if (loginBtn) loginBtn.classList.remove("hidden");
    if (userMenuTrigger) userMenuTrigger.classList.add("hidden");
    // üëÜ H·∫æT PH·∫¶N TH√äM üëÜ

    showNotification("ƒê√£ ƒëƒÉng xu·∫•t!", "info");
    showPage("home");
  } catch (error) {
    console.error("L·ªói ƒëƒÉng xu·∫•t:", error);
    showNotification("L·ªói khi ƒëƒÉng xu·∫•t!", "error");
  }
}

// ============================================
// DATA LOADING
// ============================================

/**
 * Load d·ªØ li·ªáu ban ƒë·∫ßu
 */
async function loadInitialData() {
  try {
    // Load categories
    await loadCategories();

    // Load countries
    await loadCountries();

    // Load movies
    await loadMovies();

    // Populate filter dropdowns
    populateFilters();
  } catch (error) {
    console.error("L·ªói load d·ªØ li·ªáu:", error);
  }
}

/**
 * Load danh s√°ch th·ªÉ lo·∫°i
 */
async function loadCategories() {
  try {
    if (db) {
      const snapshot = await db.collection("categories").get();
      if (!snapshot.empty) {
        allCategories = snapshot.docs.map((doc) => ({
          id: doc.id,
          ...doc.data(),
        }));
      } else {
        // S·ª≠ d·ª•ng sample data v√† t·∫°o trong Firestore
        allCategories = SAMPLE_CATEGORIES;
        await initializeSampleCategories();
      }
    } else {
      allCategories = SAMPLE_CATEGORIES;
    }
  } catch (error) {
    console.error("L·ªói load categories:", error);
    allCategories = SAMPLE_CATEGORIES;
  }
}

/**
 * Load danh s√°ch qu·ªëc gia
 */
async function loadCountries() {
  try {
    if (db) {
      const snapshot = await db.collection("countries").get();
      if (!snapshot.empty) {
        allCountries = snapshot.docs.map((doc) => ({
          id: doc.id,
          ...doc.data(),
        }));
      } else {
        allCountries = SAMPLE_COUNTRIES;
        await initializeSampleCountries();
      }
    } else {
      allCountries = SAMPLE_COUNTRIES;
    }
  } catch (error) {
    console.error("L·ªói load countries:", error);
    allCountries = SAMPLE_COUNTRIES;
  }
}

/**
 * Load danh s√°ch phim
 */
async function loadMovies() {
  try {
    if (db) {
      const snapshot = await db
        .collection("movies")
        .where("status", "==", "public")
        .orderBy("createdAt", "desc")
        .get();

      if (!snapshot.empty) {
        allMovies = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
      } else {
        allMovies = SAMPLE_MOVIES;
        await initializeSampleMovies();
      }
    } else {
      allMovies = SAMPLE_MOVIES;
    }

    // Render movies
    renderFeaturedMovies();
    renderNewMovies();
    renderAllMovies();
  } catch (error) {
    console.error("L·ªói load movies:", error);
    allMovies = SAMPLE_MOVIES;
    renderFeaturedMovies();
    renderNewMovies();
    renderAllMovies();
  }
}

/**
 * Kh·ªüi t·∫°o sample categories trong Firestore
 */
async function initializeSampleCategories() {
  if (!db) return;

  try {
    const batch = db.batch();
    SAMPLE_CATEGORIES.forEach((cat) => {
      const ref = db.collection("categories").doc(cat.id);
      batch.set(ref, cat);
    });
    await batch.commit();
    console.log("‚úÖ ƒê√£ kh·ªüi t·∫°o sample categories");
  } catch (error) {
    console.error("L·ªói kh·ªüi t·∫°o categories:", error);
  }
}

/**
 * Kh·ªüi t·∫°o sample countries trong Firestore
 */
async function initializeSampleCountries() {
  if (!db) return;

  try {
    const batch = db.batch();
    SAMPLE_COUNTRIES.forEach((country) => {
      const ref = db.collection("countries").doc(country.id);
      batch.set(ref, country);
    });
    await batch.commit();
    console.log("‚úÖ ƒê√£ kh·ªüi t·∫°o sample countries");
  } catch (error) {
    console.error("L·ªói kh·ªüi t·∫°o countries:", error);
  }
}

/**
 * Kh·ªüi t·∫°o sample movies trong Firestore
 */
async function initializeSampleMovies() {
  if (!db) return;

  try {
    const batch = db.batch();
    SAMPLE_MOVIES.forEach((movie) => {
      const ref = db.collection("movies").doc(movie.id);
      batch.set(ref, {
        ...movie,
        createdAt: firebase.firestore.Timestamp.fromDate(movie.createdAt),
      });
    });
    await batch.commit();
    console.log("‚úÖ ƒê√£ kh·ªüi t·∫°o sample movies");
  } catch (error) {
    console.error("L·ªói kh·ªüi t·∫°o movies:", error);
  }
}

// ============================================
// MOVIE RENDERING
// ============================================

/**
 * Render phim n·ªïi b·∫≠t
 */
function renderFeaturedMovies() {
  const container = document.getElementById("featuredMovies");
  if (!container) return;

  // L·∫•y 4 phim c√≥ rating cao nh·∫•t
  const featured = [...allMovies]
    .sort((a, b) => (b.rating || 0) - (a.rating || 0))
    .slice(0, 4);

  container.innerHTML = featured
    .map((movie) => createMovieCard(movie))
    .join("");
}

/**
 * Render phim m·ªõi
 */
function renderNewMovies() {
  const container = document.getElementById("newMovies");
  if (!container) return;

  // L·∫•y 8 phim m·ªõi nh·∫•t
  const newMovies = [...allMovies]
    .sort((a, b) => {
      const dateA = a.createdAt?.toDate
        ? a.createdAt.toDate()
        : new Date(a.createdAt);
      const dateB = b.createdAt?.toDate
        ? b.createdAt.toDate()
        : new Date(b.createdAt);
      return dateB - dateA;
    })
    .slice(0, 8);

  container.innerHTML = newMovies
    .map((movie) => createMovieCard(movie))
    .join("");
}

/**
 * Render t·∫•t c·∫£ phim
 */
function renderAllMovies(movies = null) {
  const container = document.getElementById("allMovies");
  if (!container) return;

  const moviesToRender = movies || allMovies;

  if (moviesToRender.length === 0) {
    container.innerHTML =
      '<p class="text-center text-muted">Kh√¥ng c√≥ phim n√†o</p>';
    return;
  }

  container.innerHTML = moviesToRender
    .map((movie) => createMovieCard(movie))
    .join("");
}

/**
 * T·∫°o HTML cho movie card (Phi√™n b·∫£n Netflix Pro - N√∫t to & R√µ ch·ªØ)
 * T·∫°o HTML cho movie card (ƒê√£ t√≠ch h·ª£p n√∫t Th√≠ch th√¥ng minh)
 */
function createMovieCard(movie) {
  // 1. T·∫°o Tags (Hot, M·ªõi...)
  const tagsHtml = (movie.tags || [])
    .map((tag) => {
      let tagClass = "";
      if (tag === "hot") tagClass = "hot";
      else if (tag === "m·ªõi") tagClass = "new";
      return `<span class="tag ${tagClass}">${tag}</span>`;
    })
    .join("");

  // 2. T·∫°o nh√£n Ph·∫ßn/M√πa
  const partHtml = movie.part
    ? `<span style="background: var(--accent-primary); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 6px; text-transform: uppercase; vertical-align: middle;">${movie.part}</span>`
    : "";

  // üëá 3. LOGIC KI·ªÇM TRA ƒê√É TH√çCH HAY CH∆ØA (M·ªöI TH√äM) üëá
  // Ki·ªÉm tra xem ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a v√† phim c√≥ trong danh s√°ch y√™u th√≠ch kh√¥ng
  let isLiked = false;
  if (
    typeof currentUser !== "undefined" &&
    currentUser &&
    currentUser.favorites
  ) {
    isLiked = currentUser.favorites.includes(movie.id);
  }

  // Thi·∫øt l·∫≠p giao di·ªán cho n√∫t Like d·ª±a tr√™n tr·∫°ng th√°i
  const likeBtnStyle = isLiked
    ? "color: #e50914; border-color: #e50914;" // ƒê·ªè (ƒê√£ th√≠ch)
    : "color: #fff; border-color: rgba(255, 255, 255, 0.2);"; // Tr·∫Øng (Ch∆∞a th√≠ch)

  const likeIcon = isLiked ? "fas fa-heart" : "far fa-heart"; // Icon ƒë·∫∑c ho·∫∑c r·ªóng
  const likeText = isLiked ? "ƒê√£ th√≠ch" : "Th√≠ch";
  const likeClass = isLiked ? "liked" : "";
  // üëÜ H·∫æT PH·∫¶N LOGIC M·ªöI üëÜ

  return `
    <div class="movie-card-wrapper">
        <div class="card movie-card-static">
            <div class="card-image">
                <img src="${movie.posterUrl}" alt="${movie.title}" loading="lazy" onerror="this.src='https://via.placeholder.com/300x450?text=No+Image'">
                <div class="card-overlay">
                    <button class="btn btn-primary"><i class="fas fa-play"></i></button>
                </div>
            </div>
            
            <div class="card-body">
                <h4 class="card-title" title="${movie.title}">
                    ${movie.title} ${partHtml}
                </h4>
                <div class="card-meta">
                    <span>${movie.year || "N/A"}</span>
                    <span class="card-rating"><i class="fas fa-star"></i> ${movie.rating || 0}</span>
                </div>
                <div class="card-price">
                    <i class="fas fa-coins"></i> ${movie.price} CRO
                </div>
            </div>
        </div>

        <div class="movie-card-popup" onclick="viewMovieDetail('${movie.id}')">
            <div class="popup-image">
                <img src="${movie.posterUrl}" alt="${movie.title}">
                <div class="popup-play-overlay">
                   <i class="fas fa-play-circle"></i>
                </div>
            </div>
            
            <div class="popup-info">
                <h4 class="popup-title">${movie.title} ${partHtml}</h4>

                <div class="popup-meta">
                    <span class="match-score">98% Ph√π h·ª£p</span>
                    <span class="age-badge">T16</span>
                    <span>${movie.year}</span>
                    <span class="quality-badge">HD</span>
                </div>

                <div class="popup-actions-row">
                    <button class="btn-netflix-primary" title="Xem ngay">
                        <i class="fas fa-play"></i> Xem ngay
                    </button>
                    
                    <button class="btn-netflix-secondary ${likeClass} btn-like-${movie.id}" 
                            title="Th√≠ch" 
                            style="${likeBtnStyle}"
                            onclick="event.stopPropagation(); toggleFavorite('${movie.id}')">
                        <i class="${likeIcon}"></i> ${likeText}
                    </button>
                    <button class="btn-netflix-secondary" title="Chi ti·∫øt">
                        <i class="fas fa-info-circle"></i> Chi ti·∫øt
                    </button>
                </div>
                <div class="popup-genres">
                    <span>${movie.category}</span>
                    <span class="dot">‚Ä¢</span>
                    <span>${movie.country}</span>
                </div>
            </div>
        </div>
    </div>
  `;
}

// ============================================
// MOVIE DETAIL
// ============================================

/**
 * Xem chi ti·∫øt phim
 */
/**
 * Xem chi ti·∫øt phim (ƒê√£ n√¢ng c·∫•p: T·ª± ƒë·ªông nh·ªõ t·∫≠p ƒëang xem d·ªü)
 */
async function viewMovieDetail(movieId) {
  currentMovieId = movieId;
  // M·∫∑c ƒë·ªãnh l√† t·∫≠p ƒë·∫ßu ti√™n (0)
  currentEpisode = 0;

  // 1. T√¨m th√¥ng tin phim
  let movie = allMovies.find((m) => m.id === movieId);

  // N·∫øu kh√¥ng c√≥ trong cache th√¨ t√¨m trong Firestore
  if (!movie && db) {
    try {
      const doc = await db.collection("movies").doc(movieId).get();
      if (doc.exists) {
        movie = { id: doc.id, ...doc.data() };
      }
    } catch (error) {
      console.error("L·ªói load movie detail:", error);
    }
  }

  if (!movie) {
    showNotification("Kh√¥ng t√¨m th·∫•y phim!", "error");
    return;
  }

  // üëá 2. LOGIC M·ªöI: KH√îI PH·ª§C L·ªäCH S·ª¨ XEM (QUAN TR·ªåNG) üëá
  if (currentUser && db) {
    try {
      const historyDoc = await db
        .collection("users")
        .doc(currentUser.uid)
        .collection("history")
        .doc(movieId)
        .get();

      if (historyDoc.exists) {
        const data = historyDoc.data();
        // N·∫øu c√≥ d·ªØ li·ªáu t·∫≠p c≈© -> G√°n l·∫°i cho currentEpisode
        if (data.lastEpisode !== undefined) {
          currentEpisode = data.lastEpisode;
          console.log(
            `üîÑ ƒê√£ kh√¥i ph·ª•c: B·∫°n ƒëang xem t·∫≠p ${currentEpisode + 1}`,
          );
        }
      }

      // C·∫≠p nh·∫≠t l·∫°i th·ªùi gian "V·ª´a m·ªõi xem" l√™n ƒë·∫ßu danh s√°ch
      saveWatchHistory(movieId, currentEpisode);
    } catch (error) {
      console.error("L·ªói kh√¥i ph·ª•c l·ªãch s·ª≠:", error);
    }
  }
  // üëÜ H·∫æT PH·∫¶N S·ª¨A üëÜ

  // 3. C·∫≠p nh·∫≠t l∆∞·ª£t xem
  updateMovieViews(movieId);

  // 4. ƒêi·ªÅn th√¥ng tin v√†o giao di·ªán (Gi·ªØ nguy√™n code c≈©)
  document.getElementById("detailPoster").src = movie.posterUrl;
  document.getElementById("detailTitle").textContent = movie.title;
  document.getElementById("detailYear").textContent = movie.year || "N/A";
  document.getElementById("detailCountry").textContent = movie.country || "N/A";
  document.getElementById("detailCategory").textContent =
    movie.category || "N/A";
  document.getElementById("detailViews").textContent = formatNumber(
    movie.views || 0,
  );
  document.getElementById("detailRating").textContent = movie.rating || 0;
  document.getElementById("detailDescription").textContent =
    movie.description || "Ch∆∞a c√≥ m√¥ t·∫£";
  document.getElementById("detailPrice").textContent = movie.price || 0;

  // Render tags
  const tagsContainer = document.getElementById("detailTags");
  tagsContainer.innerHTML = (movie.tags || [])
    .map((tag) => {
      let tagClass = "";
      if (tag === "hot") tagClass = "hot";
      else if (tag === "m·ªõi") tagClass = "new";
      return `<span class="tag ${tagClass}">${tag}</span>`;
    })
    .join("");

  // 5. Render danh s√°ch t·∫≠p (Quan tr·ªçng: N√≥ s·∫Ω d√πng currentEpisode ƒë·ªÉ highlight t·∫≠p ƒëang xem)
  renderEpisodes(movie.episodes || []);

  // 6. Ki·ªÉm tra quy·ªÅn xem v√† t·∫£i Video
  await checkAndUpdateVideoAccess();

  // 7. T·∫£i b√¨nh lu·∫≠n
  loadComments(movieId);

  // 8. Chuy·ªÉn trang
  showPage("movieDetail");
}

/**
 * Render danh s√°ch t·∫≠p phim
 */
function renderEpisodes(episodes) {
  const container = document.getElementById("episodesList");
  const section = document.getElementById("episodesSection");

  if (!episodes || episodes.length <= 1) {
    section.classList.add("hidden");
    return;
  }

  section.classList.remove("hidden");

  container.innerHTML = episodes
    .map(
      (ep, index) => `
        <div class="episode-item ${index === currentEpisode ? "active" : ""}" 
             onclick="selectEpisode(${index})">
            <div class="episode-number">T·∫≠p ${ep.episodeNumber}</div>
            <div class="episode-title">${ep.title || ""}</div>
            <small class="text-muted">${ep.duration || ""} ‚Ä¢ ${ep.quality || "HD"}</small>
        </div>
    `,
    )
    .join("");
}

/**
 * Ch·ªçn t·∫≠p phim
 */
function selectEpisode(index) {
  currentEpisode = index;

  // Update active state
  document.querySelectorAll(".episode-item").forEach((el, i) => {
    el.classList.toggle("active", i === index);
  });
  // üëá TH√äM D√íNG N√ÄY: L∆∞u l·ªãch s·ª≠ xem ngay khi ch·ªçn t·∫≠p üëá
  if (currentMovieId) {
    saveWatchHistory(currentMovieId, index);
  }
  // Update video if unlocked
  checkAndUpdateVideoAccess();
}

/**
 * Ki·ªÉm tra v√† c·∫≠p nh·∫≠t quy·ªÅn xem video
 */
async function checkAndUpdateVideoAccess() {
  const videoLocked = document.getElementById("videoLocked");
  const videoPlayer = document.getElementById("videoPlayer");
  const buyTicketBtn = document.getElementById("buyTicketBtn");

  let hasAccess = false;

  // Admin lu√¥n c√≥ quy·ªÅn xem
  if (isAdmin) {
    hasAccess = true;
  }
  // üëá 2. TH√äM ƒêO·∫†N N√ÄY: VIP lu√¥n ƒë∆∞·ª£c xem üëá
  else if (currentUser && currentUser.isVip === true) {
    hasAccess = true;

    // ƒê·ªïi n√∫t mua v√© th√†nh n√∫t th√¥ng b√°o VIP
    if (buyTicketBtn) {
      buyTicketBtn.innerHTML = '<i class="fas fa-crown"></i> ƒê·∫∑c quy·ªÅn VIP';
      buyTicketBtn.classList.add("btn-vip-action"); // Th√™m class m√†u v√†ng
      buyTicketBtn.style.background =
        "linear-gradient(45deg, #fcd535, #ff9900)";
      buyTicketBtn.style.color = "#000";
      buyTicketBtn.style.border = "none";
      buyTicketBtn.disabled = true; // Kh√¥ng cho b·∫•m mua n·ªØa
    }
  } else if (currentUser && currentMovieId) {
    // Ki·ªÉm tra ƒë√£ mua ch∆∞a
    hasAccess = await checkMoviePurchased(currentMovieId);
  }

  if (hasAccess) {
    // M·ªü kh√≥a giao di·ªán (Code c≈©)
    videoLocked.classList.add("hidden");
    videoPlayer.classList.remove("hidden");
    buyTicketBtn.innerHTML = '<i class="fas fa-check"></i> ƒê√£ mua v√©';
    buyTicketBtn.disabled = true;
    buyTicketBtn.classList.remove("btn-primary");
    buyTicketBtn.classList.add("btn-success");

    // üëá ƒêO·∫†N CODE X·ª¨ L√ù LINK TH√îNG MINH (S·ª¨A ·ªû ƒê√ÇY) üëá
    const movie = allMovies.find((m) => m.id === currentMovieId);
    if (movie && movie.episodes && movie.episodes[currentEpisode]) {
      let videoId = movie.episodes[currentEpisode].youtubeId; // L·∫•y c√°i chu·ªói b·∫°n nh·∫≠p v√†o
      let embedUrl = "";

      // 1. Ki·ªÉm tra n·∫øu l√† OK.RU (V√≠ d·ª• nh·∫≠p: 123456789 ho·∫∑c link ok.ru/video/123...)
      if (videoId.includes("ok.ru")) {
        // T·ª± ƒë·ªông chuy·ªÉn link th∆∞·ªùng th√†nh link Embed
        // V√≠ d·ª•: https://ok.ru/video/12345 -> https://ok.ru/videoembed/12345
        const id = videoId.split("/").pop(); // L·∫•y s·ªë cu·ªëi c√πng
        embedUrl = `https://ok.ru/videoembed/${id}`;
      }
      // 2. Ki·ªÉm tra n·∫øu l√† Google Drive (ID d√†i > 25 k√Ω t·ª±)
      else if (videoId.length > 25) {
        embedUrl = `https://drive.google.com/file/d/${videoId}/preview`;
      }
      // 3. M·∫∑c ƒë·ªãnh coi nh∆∞ l√† YouTube (ID ng·∫Øn 11 k√Ω t·ª±)
      else {
        embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=0&rel=0`;
      }

      // G√°n link ƒë√£ x·ª≠ l√Ω v√†o Player
      videoPlayer.src = embedUrl;
    }
  } else {
    // Kh√≥a video
    videoLocked.classList.remove("hidden");
    videoPlayer.classList.add("hidden");
    videoPlayer.src = "";
    buyTicketBtn.innerHTML = '<i class="fas fa-ticket-alt"></i> Mua V√© Ngay';
    buyTicketBtn.disabled = false;
    buyTicketBtn.classList.add("btn-primary");
    buyTicketBtn.classList.remove("btn-success");
  }
}

/**
 * C·∫≠p nh·∫≠t l∆∞·ª£t xem
 */
async function updateMovieViews(movieId) {
  if (!db) return;

  try {
    await db
      .collection("movies")
      .doc(movieId)
      .update({
        views: firebase.firestore.FieldValue.increment(1),
      });
  } catch (error) {
    console.error("L·ªói c·∫≠p nh·∫≠t views:", error);
  }
}

// ============================================
// PAYMENT / BUY TICKET
// ============================================

/**
 * Mua v√© xem phim
 */
async function buyTicket() {
  if (!currentUser) {
    showNotification("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ mua v√©!", "warning");
    openAuthModal();
    return;
  }

  const movie = allMovies.find((m) => m.id === currentMovieId);
  if (!movie) {
    showNotification("Kh√¥ng t√¨m th·∫•y th√¥ng tin phim!", "error");
    return;
  }

  // Ki·ªÉm tra ƒë√£ mua ch∆∞a
  const alreadyPurchased = await checkMoviePurchased(currentMovieId);
  if (alreadyPurchased) {
    showNotification("B·∫°n ƒë√£ mua v√© phim n√†y r·ªìi!", "info");
    checkAndUpdateVideoAccess();
    return;
  }

  // Th·ª±c hi·ªán thanh to√°n
  const txHash = await payWithCRO(movie.price, currentMovieId, movie.title);

  if (txHash) {
    // Thanh to√°n th√†nh c√¥ng - m·ªü kh√≥a video
    await checkAndUpdateVideoAccess();
  }
}

// ============================================
// COMMENTS
// ============================================

/**
 * Load b√¨nh lu·∫≠n
 */
async function loadComments(movieId) {
  const container = document.getElementById("commentsList");

  try {
    let comments = [];

    if (db) {
      const snapshot = await db
        .collection("comments")
        .where("movieId", "==", movieId)
        .orderBy("createdAt", "desc")
        .limit(50)
        .get();

      comments = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
    }

    if (comments.length === 0) {
      container.innerHTML =
        '<p class="text-center text-muted">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</p>';
      return;
    }

    container.innerHTML = comments
      .map((comment) => createCommentHtml(comment))
      .join("");
  } catch (error) {
    console.error("L·ªói load comments:", error);
    container.innerHTML =
      '<p class="text-center text-muted">Kh√¥ng th·ªÉ t·∫£i b√¨nh lu·∫≠n</p>';
  }
}

/**
 * T·∫°o HTML cho comment
 */
function createCommentHtml(comment) {
  const initial = (comment.userName || "U")[0].toUpperCase();
  const time = comment.createdAt?.toDate
    ? formatTimeAgo(comment.createdAt.toDate())
    : "V·ª´a xong";

  const deleteBtn =
    isAdmin || (currentUser && currentUser.uid === comment.userId)
      ? `<button class="btn btn-sm btn-danger" onclick="deleteComment('${comment.id}')">
               <i class="fas fa-trash"></i>
           </button>`
      : "";

  return `
        <div class="comment-item" id="comment-${comment.id}">
            <div class="comment-avatar">${initial}</div>
            <div class="comment-content">
                <div class="comment-header">
                    <span class="comment-author">${comment.userName || "·∫®n danh"}</span>
                    <span class="comment-rating">
                        <i class="fas fa-star"></i> ${comment.rating || 0}/10
                    </span>
                </div>
                <p class="comment-text">${escapeHtml(comment.content)}</p>
                <div class="comment-time">${time}</div>
                <div class="comment-actions">${deleteBtn}</div>
            </div>
        </div>
    `;
}

/**
 * G·ª≠i b√¨nh lu·∫≠n
 */
async function submitComment() {
  if (!currentUser) {
    showNotification("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ b√¨nh lu·∫≠n!", "warning");
    openAuthModal();
    return;
  }

  const content = document.getElementById("commentContent").value.trim();

  if (!content) {
    showNotification("Vui l√≤ng nh·∫≠p n·ªôi dung b√¨nh lu·∫≠n!", "warning");
    return;
  }

  if (selectedRating === 0) {
    showNotification("Vui l√≤ng ch·ªçn ƒë√°nh gi√°!", "warning");
    return;
  }

  if (!db) {
    showNotification("Firebase ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh!", "error");
    return;
  }

  try {
    showLoading(true, "ƒêang g·ª≠i b√¨nh lu·∫≠n...");

    await db.collection("comments").add({
      movieId: currentMovieId,
      userId: currentUser.uid,
      userName: currentUser.displayName || currentUser.email.split("@")[0],
      userAvatar: currentUser.photoURL || "",
      content: content,
      rating: selectedRating,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    });

    // Reset form
    document.getElementById("commentContent").value = "";
    selectedRating = 0;
    updateRatingStars(0);
    document.getElementById("ratingValue").textContent = "0/10";

    // Reload comments
    await loadComments(currentMovieId);

    // C·∫≠p nh·∫≠t rating trung b√¨nh c·ªßa phim
    await updateMovieRating(currentMovieId);

    showNotification("ƒê√£ g·ª≠i b√¨nh lu·∫≠n!", "success");
  } catch (error) {
    console.error("L·ªói g·ª≠i comment:", error);
    showNotification("Kh√¥ng th·ªÉ g·ª≠i b√¨nh lu·∫≠n!", "error");
  } finally {
    showLoading(false);
  }
}

/**
 * X√≥a b√¨nh lu·∫≠n
 */
async function deleteComment(commentId) {
  if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√¨nh lu·∫≠n n√†y?")) return;

  if (!db) return;

  try {
    await db.collection("comments").doc(commentId).delete();

    // Remove from DOM
    const commentEl = document.getElementById(`comment-${commentId}`);
    if (commentEl) {
      commentEl.remove();
    }

    showNotification("ƒê√£ x√≥a b√¨nh lu·∫≠n!", "success");
  } catch (error) {
    console.error("L·ªói x√≥a comment:", error);
    showNotification("Kh√¥ng th·ªÉ x√≥a b√¨nh lu·∫≠n!", "error");
  }
}

/**
 * C·∫≠p nh·∫≠t rating trung b√¨nh c·ªßa phim
 */
async function updateMovieRating(movieId) {
  if (!db) return;

  try {
    const snapshot = await db
      .collection("comments")
      .where("movieId", "==", movieId)
      .get();

    if (snapshot.empty) return;

    const ratings = snapshot.docs.map((doc) => doc.data().rating || 0);
    const avgRating = (
      ratings.reduce((a, b) => a + b, 0) / ratings.length
    ).toFixed(1);

    await db
      .collection("movies")
      .doc(movieId)
      .update({
        rating: parseFloat(avgRating),
      });
  } catch (error) {
    console.error("L·ªói c·∫≠p nh·∫≠t rating:", error);
  }
}

// ============================================
// ADMIN FUNCTIONS
// ============================================

/**
 * Load d·ªØ li·ªáu cho Admin
 */
async function loadAdminData() {
  if (!isAdmin) return;

  try {
    // Load stats
    await loadAdminStats();

    // Load movies for admin
    await loadAdminMovies();

    // Load users
    await loadAdminUsers();

    // Load comments
    await loadAdminComments();

    // Load transactions
    await loadAdminTransactions();

    // Populate movie select for episodes
    //populateMovieSelect();

    // Load categories and countries tables
    renderAdminCategories();
    renderAdminCountries();
  } catch (error) {
    console.error("L·ªói load admin data:", error);
  }
}

/**
 * Load th·ªëng k√™ Admin
 */
async function loadAdminStats() {
  try {
    // T·ªïng s·ªë phim
    document.getElementById("statTotalMovies").textContent = allMovies.length;

    // T·ªïng l∆∞·ª£t xem
    const totalViews = allMovies.reduce((sum, m) => sum + (m.views || 0), 0);
    document.getElementById("statTotalViews").textContent =
      formatNumber(totalViews);

    // Doanh thu ∆∞·ªõc t√≠nh
    let totalRevenue = 0;
    if (db) {
      const txSnapshot = await db
        .collection("transactions")
        .where("status", "==", "completed")
        .get();
      totalRevenue = txSnapshot.docs.reduce(
        (sum, doc) => sum + (doc.data().amount || 0),
        0,
      );
    }
    document.getElementById("statTotalRevenue").textContent =
      `${formatNumber(totalRevenue)} CRO`;

    // T·ªïng users
    let totalUsers = 0;
    if (db) {
      const usersSnapshot = await db.collection("users").get();
      totalUsers = usersSnapshot.size;
    }
    document.getElementById("statTotalUsers").textContent =
      formatNumber(totalUsers);

    // Recent movies
    renderRecentMovies();
  } catch (error) {
    console.error("L·ªói load stats:", error);
  }
}

/**
 * Render phim g·∫ßn ƒë√¢y trong dashboard
 */
function renderRecentMovies() {
  const tbody = document.getElementById("recentMoviesTable");

  const recent = [...allMovies]
    .sort((a, b) => {
      const dateA = a.createdAt?.toDate
        ? a.createdAt.toDate()
        : new Date(a.createdAt);
      const dateB = b.createdAt?.toDate
        ? b.createdAt.toDate()
        : new Date(b.createdAt);
      return dateB - dateA;
    })
    .slice(0, 5);

  tbody.innerHTML = recent
    .map((movie) => {
      const date = movie.createdAt?.toDate
        ? movie.createdAt.toDate()
        : new Date(movie.createdAt);
      return `
            <tr>
                <td><img src="${movie.posterUrl}" alt="${movie.title}" onerror="this.src='https://via.placeholder.com/50x75'"></td>
                <td>${movie.title}</td>
                <td>${movie.price} CRO</td>
                <td><span class="status-badge ${movie.status}">${getStatusText(movie.status)}</span></td>
                <td>${formatDate(date)}</td>
            </tr>
        `;
    })
    .join("");
}

/**
 * Load danh s√°ch phim cho Admin
 */
async function loadAdminMovies() {
  const tbody = document.getElementById("adminMoviesTable");

  try {
    let movies = [];

    // 1. L·∫•y T·∫§T C·∫¢ phim t·ª´ Firestore (M·ªõi nh·∫•t l√™n ƒë·∫ßu)
    if (db) {
      const snapshot = await db
        .collection("movies")
        .orderBy("createdAt", "desc")
        .get();
      movies = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
    } else {
      movies = allMovies; // D·ªØ li·ªáu m·∫´u n·∫øu ch∆∞a c√≥ DB
    }

    // 2. Render B·∫£ng Qu·∫£n l√Ω Phim Ch√≠nh
    tbody.innerHTML = movies
      .map(
        (movie) => `
            <tr>
                <td><img src="${movie.posterUrl}" alt="${movie.title}" onerror="this.src='https://via.placeholder.com/50x75'"></td>
                <td>${movie.title}</td>
                <td>${movie.category || "N/A"}</td>
                <td>${movie.price}</td>
                <td>${formatNumber(movie.views || 0)}</td>
                <td><span class="status-badge ${movie.status}">${getStatusText(movie.status)}</span></td>
                <td>
                    <button class="btn btn-sm btn-secondary" onclick="editMovie('${movie.id}')" title="S·ª≠a">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteMovie('${movie.id}')" title="X√≥a">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `,
      )
      .join("");

    // =======================================================
    // üëá ƒêO·∫†N CODE M·ªöI TH√äM ƒê·ªÇ FIX L·ªñI C·ª¶A B·∫†N üëá
    // =======================================================

    // 3. C·∫≠p nh·∫≠t ngay Menu ch·ªçn phim (Tab Qu·∫£n l√Ω T·∫≠p)
    const select = document.getElementById("selectMovieForEpisodes");
    if (select) {
      select.innerHTML =
        '<option value="">-- Ch·ªçn phim --</option>' +
        movies
          .map((m) => `<option value="${m.id}">${m.title}</option>`)
          .join("");
    }

    // 4. C·∫≠p nh·∫≠t ngay B·∫£ng "Phim m·ªõi th√™m g·∫ßn ƒë√¢y" (Dashboard)
    const recentTbody = document.getElementById("recentMoviesTable");
    if (recentTbody) {
      const recent = movies.slice(0, 5); // L·∫•y 5 phim m·ªõi nh·∫•t
      recentTbody.innerHTML = recent
        .map((movie) => {
          const date = movie.createdAt?.toDate
            ? movie.createdAt.toDate()
            : new Date(movie.createdAt);
          return `
                <tr>
                    <td><img src="${movie.posterUrl}" alt="${movie.title}" onerror="this.src='https://via.placeholder.com/50x75'"></td>
                    <td>${movie.title}</td>
                    <td>${movie.price} CRO</td>
                    <td><span class="status-badge ${movie.status}">${getStatusText(movie.status)}</span></td>
                    <td>${formatDate(date)}</td>
                </tr>
             `;
        })
        .join("");
    }

    // 5. C·∫≠p nh·∫≠t Th·ªëng k√™ T·ªïng s·ªë phim (Dashboard)
    const statTotal = document.getElementById("statTotalMovies");
    if (statTotal) statTotal.textContent = movies.length;

    // =======================================================
  } catch (error) {
    console.error("L·ªói load admin movies:", error);
  }
}

/**
 * Load danh s√°ch users cho Admin
 */
/**
 * Load danh s√°ch users cho Admin (ƒê√£ th√™m c·ªôt VIP & N√∫t k√≠ch ho·∫°t)
 */
/**
 * Load danh s√°ch users cho Admin (ƒê√£ s·ª≠a: Hi·ªán ·∫£nh Avatar th·∫≠t)
 */
async function loadAdminUsers() {
  const tbody = document.getElementById("adminUsersTable");
  if (!db) return;

  try {
    const snapshot = await db
      .collection("users")
      .orderBy("createdAt", "desc")
      .get();
    const users = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));

    tbody.innerHTML = users
      .map((user) => {
        const date = user.createdAt?.toDate
          ? formatDate(user.createdAt.toDate())
          : "N/A";
        const initial = (user.displayName ||
          user.email ||
          "U")[0].toUpperCase();

        // Avatar Logic
        let avatarHtml =
          user.avatar && user.avatar.startsWith("http")
            ? `<img src="${user.avatar}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">`
            : `<div class="comment-avatar" style="width:40px;height:40px;font-size:14px;">${initial}</div>`;

        // üëá LOGIC T√çNH TH·ªúI H·∫†N VIP üëá
        const isVip = user.isVip === true;
        let expiryText = "-";

        if (isVip) {
          if (user.vipExpiresAt) {
            // TR∆Ø·ªúNG H·ª¢P C√ì TH·ªúI H·∫†N
            const expiryDate = user.vipExpiresAt.toDate();
            const now = new Date();
            const diffTime = expiryDate - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays > 0) {
              expiryText = `<span style="color: #00d4ff; font-weight:bold;">C√≤n ${diffDays} ng√†y</span>`;
            } else {
              expiryText = `<span style="color: #ff4444; font-weight:bold;">ƒê√£ h·∫øt h·∫°n</span>`;
            }
          } else {
            // TR∆Ø·ªúNG H·ª¢P Vƒ®NH VI·ªÑN (vipExpiresAt l√† null)
            expiryText = `<span class="tag" style="background: linear-gradient(45deg, #00d4ff, #00ff88); color: #000; font-weight:800;">‚ôæÔ∏è Vƒ®NH VI·ªÑN</span>`;
          }
        }
        // üëÜ H·∫æT LOGIC T√çNH H·∫†N üëÜ

        const vipBadge = isVip
          ? `<span class="status-badge vip"><i class="fas fa-crown"></i> VIP</span>`
          : `<span class="status-badge free">Free</span>`;
        const vipBtnClass = isVip ? "btn-secondary" : "btn-vip-action";
        const vipIcon = isVip ? "fa-ban" : "fa-crown";

        return `
            <tr>
                <td>${avatarHtml}</td>
                <td>${user.email}</td>
                <td>${user.displayName || "N/A"}</td>
                <td><span class="status-badge ${user.role === "admin" ? "public" : ""}">${user.role || "user"}</span></td>
                <td><span class="status-badge ${user.isActive ? "active" : "blocked"}">${user.isActive ? "Ho·∫°t ƒë·ªông" : "B·ªã kh√≥a"}</span></td>
                <td>${vipBadge}</td>
                
                <td style="font-size: 13px;">${expiryText}</td>
                
                <td>${date}</td>
                <td>
                    <button class="btn btn-sm ${vipBtnClass}" onclick="toggleUserVip('${user.id}', ${!isVip})">
                        <i class="fas ${vipIcon}"></i>
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="openUserRoleModal('${user.id}', '${user.email}', '${user.role}')"><i class="fas fa-user-cog"></i></button>
                    <button class="btn btn-sm ${user.isActive ? "btn-danger" : "btn-success"}" onclick="toggleUserStatus('${user.id}', ${!user.isActive})"><i class="fas fa-${user.isActive ? "lock" : "unlock"}"></i></button>
                <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}', '${user.email}')" title="X√≥a vƒ©nh vi·ªÖn">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    </td>
            </tr>
        `;
      })
      .join("");
  } catch (error) {
    console.error(error);
  }
}

// üëá H√ÄM M·ªöI: C·∫§P VIP C√ì TH·ªúI H·∫†N üëá
// üëá H√ÄM C·∫§P VIP (ƒê√É C√ì T√ôY CH·ªåN Vƒ®NH VI·ªÑN) üëá
async function toggleUserVip(userId, setVip) {
  if (!db) return;

  let expiryDate = null; // M·∫∑c ƒë·ªãnh l√† null (Vƒ©nh vi·ªÖn ho·∫∑c H·ªßy)
  let days = 0;
  let message = "";

  if (setVip) {
    // H∆∞·ªõng d·∫´n Admin nh·∫≠p -1 ƒë·ªÉ set vƒ©nh vi·ªÖn
    const input = prompt(
      "Nh·∫≠p s·ªë ng√†y VIP (V√≠ d·ª•: 30).\nüëâ Nh·∫≠p -1 ƒë·ªÉ c·∫•p Vƒ®NH VI·ªÑN.",
      "30",
    );

    if (input === null) return; // N·∫øu b·∫•m h·ªßy

    days = parseInt(input);

    if (isNaN(days)) {
      alert("Vui l√≤ng nh·∫≠p s·ªë!");
      return;
    }

    if (days === -1) {
      // TR∆Ø·ªúNG H·ª¢P Vƒ®NH VI·ªÑN
      expiryDate = null; // Kh√¥ng c√≥ ng√†y h·∫øt h·∫°n
      message = "ƒê√£ c·∫•p VIP Vƒ®NH VI·ªÑN! ‚ôæÔ∏è";
    } else if (days > 0) {
      // TR∆Ø·ªúNG H·ª¢P C√ì TH·ªúI H·∫†N
      const now = new Date();
      expiryDate = new Date(now.setDate(now.getDate() + days));
      message = `ƒê√£ c·∫•p VIP ${days} ng√†y!`;
    } else {
      alert("S·ªë ng√†y kh√¥ng h·ª£p l·ªá!");
      return;
    }
  } else {
    // H·ª¶Y VIP
    if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën H·ª¶Y VIP c·ªßa ng∆∞·ªùi d√πng n√†y?`)) return;
    message = "ƒê√£ h·ªßy VIP th√†nh c√¥ng!";
  }

  try {
    showLoading(true, "ƒêang c·∫≠p nh·∫≠t...");

    // C·∫≠p nh·∫≠t v√†o Firestore
    await db
      .collection("users")
      .doc(userId)
      .update({
        isVip: setVip,
        vipSince: setVip
          ? firebase.firestore.FieldValue.serverTimestamp()
          : null,
        vipExpiresAt: expiryDate, // L∆∞u ng√†y h·∫øt h·∫°n (ho·∫∑c null n·∫øu vƒ©nh vi·ªÖn)
      });

    showNotification(message, "success");
    await loadAdminUsers();
  } catch (error) {
    console.error("L·ªói c·∫≠p nh·∫≠t VIP:", error);
    showNotification("L·ªói c·∫≠p nh·∫≠t!", "error");
  } finally {
    showLoading(false);
  }
}

/**
 * Load b√¨nh lu·∫≠n cho Admin
 */
async function loadAdminComments() {
  const tbody = document.getElementById("adminCommentsTable");

  if (!db) {
    tbody.innerHTML =
      '<tr><td colspan="6" class="text-center">Firebase ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh</td></tr>';
    return;
  }

  try {
    const snapshot = await db
      .collection("comments")
      .orderBy("createdAt", "desc")
      .limit(100)
      .get();

    const comments = snapshot.docs.map((doc) => ({
      id: doc.id,
      ...doc.data(),
    }));

    tbody.innerHTML = comments
      .map((comment) => {
        const movie = allMovies.find((m) => m.id === comment.movieId);
        const time = comment.createdAt?.toDate
          ? formatTimeAgo(comment.createdAt.toDate())
          : "N/A";

        return `
                <tr>
                    <td>${comment.userName || "·∫®n danh"}</td>
                    <td>${movie?.title || comment.movieId}</td>
                    <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(comment.content)}</td>
                    <td><span class="card-rating"><i class="fas fa-star"></i> ${comment.rating}/10</span></td>
                    <td>${time}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteComment('${comment.id}')" title="X√≥a">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
      })
      .join("");
  } catch (error) {
    console.error("L·ªói load comments:", error);
  }
}

/**
 * Load giao d·ªãch cho Admin
 */
async function loadAdminTransactions() {
  const tbody = document.getElementById("adminTransactionsTable");

  if (!db) {
    tbody.innerHTML =
      '<tr><td colspan="6" class="text-center">Firebase ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh</td></tr>';
    return;
  }

  try {
    const snapshot = await db
      .collection("transactions")
      .orderBy("createdAt", "desc")
      .limit(100)
      .get();

    if (snapshot.empty) {
      tbody.innerHTML =
        '<tr><td colspan="6" class="text-center">Ch∆∞a c√≥ giao d·ªãch n√†o</td></tr>';
      return;
    }

    const transactions = snapshot.docs.map((doc) => ({
      id: doc.id,
      ...doc.data(),
    }));

    tbody.innerHTML = transactions
      .map((tx) => {
        const movie = allMovies.find((m) => m.id === tx.movieId);
        const time = tx.createdAt?.toDate
          ? formatDate(tx.createdAt.toDate())
          : "N/A";

        return `
                <tr>
                    <td>
                        <a href="${CURRENT_NETWORK.blockExplorerUrls[0]}/tx/${tx.txHash}" target="_blank" class="text-info">
                            ${tx.txHash.substring(0, 10)}...
                        </a>
                    </td>
                    <td>${tx.userId.substring(0, 8)}...</td>
                    <td>${movie?.title || tx.movieId}</td>
                    <td>${tx.amount} CRO</td>
                    <td><span class="status-badge ${tx.status}">${tx.status}</span></td>
                    <td>${time}</td>
                </tr>
            `;
      })
      .join("");
  } catch (error) {
    console.error("L·ªói load transactions:", error);
  }
}

// ============================================
// ADMIN CRUD - MOVIES
// ============================================

/**
 * M·ªü modal th√™m/s·ª≠a phim
 */
function openMovieModal(movieId = null) {
  const modal = document.getElementById("movieModal");
  const title = document.getElementById("movieModalTitle");
  const form = document.getElementById("movieForm");

  // Populate category and country selects
  const categorySelect = document.getElementById("movieCategory");
  const countrySelect = document.getElementById("movieCountry");

  categorySelect.innerHTML =
    '<option value="">Ch·ªçn th·ªÉ lo·∫°i</option>' +
    allCategories
      .map((c) => `<option value="${c.name}">${c.name}</option>`)
      .join("");

  countrySelect.innerHTML =
    '<option value="">Ch·ªçn qu·ªëc gia</option>' +
    allCountries
      .map((c) => `<option value="${c.name}">${c.name}</option>`)
      .join("");

  if (movieId) {
    // Edit mode
    title.textContent = "S·ª≠a Phim";
    const movie = allMovies.find((m) => m.id === movieId);

    if (movie) {
      document.getElementById("movieId").value = movieId;
      document.getElementById("movieTitle").value = movie.title;
      document.getElementById("moviePart").value = movie.part || "";
      document.getElementById("moviePoster").value = movie.posterUrl;
      document.getElementById("movieCategory").value = movie.category || "";
      document.getElementById("movieCountry").value = movie.country || "";
      document.getElementById("movieYear").value = movie.year || "";
      document.getElementById("moviePrice").value = movie.price || 0;
      document.getElementById("movieDescription").value =
        movie.description || "";
      document.getElementById("movieType").value = movie.type || "series"; // M·∫∑c ƒë·ªãnh l√† phim b·ªô n·∫øu ch∆∞a c√≥
      document.getElementById("movieTags").value = (movie.tags || []).join(
        ", ",
      );
      document.getElementById("movieStatus").value = movie.status || "public";
    }
  } else {
    // Add mode
    title.textContent = "Th√™m Phim M·ªõi";
    form.reset();
    document.getElementById("movieId").value = "";
    document.getElementById("movieYear").value = new Date().getFullYear();
    document.getElementById("movieType").value = "series"; // M·∫∑c ƒë·ªãnh khi th√™m m·ªõi
    document.getElementById("moviePart").value = "";
  }

  openModal("movieModal");
}

/**
 * X·ª≠ l√Ω submit form phim
 */
async function handleMovieSubmit(event) {
  event.preventDefault();

  if (!db) {
    showNotification("Firebase ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh!", "error");
    return;
  }

  const movieId = document.getElementById("movieId").value;
  const movieData = {
    title: document.getElementById("movieTitle").value,
    posterUrl: document.getElementById("moviePoster").value,
    category: document.getElementById("movieCategory").value,
    country: document.getElementById("movieCountry").value,
    year: parseInt(document.getElementById("movieYear").value),
    price: parseFloat(document.getElementById("moviePrice").value),
    description: document.getElementById("movieDescription").value,
    type: document.getElementById("movieType").value,
    part: document.getElementById("moviePart").value.trim(),
    tags: document
      .getElementById("movieTags")
      .value.split(",")
      .map((t) => t.trim())
      .filter((t) => t),
    status: document.getElementById("movieStatus").value,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
  };

  try {
    showLoading(true, "ƒêang l∆∞u...");

    if (movieId) {
      // Update
      await db.collection("movies").doc(movieId).update(movieData);
      showNotification("ƒê√£ c·∫≠p nh·∫≠t phim!", "success");
    } else {
      // Create
      movieData.views = 0;
      movieData.rating = 0;
      movieData.episodes = [];
      movieData.createdAt = firebase.firestore.FieldValue.serverTimestamp();

      await db.collection("movies").add(movieData);
      showNotification("ƒê√£ th√™m phim m·ªõi!", "success");
    }

    closeModal("movieModal");

    // Reload data
    await loadMovies();
    await loadAdminMovies();
  } catch (error) {
    console.error("L·ªói l∆∞u phim:", error);
    showNotification("Kh√¥ng th·ªÉ l∆∞u phim!", "error");
  } finally {
    showLoading(false);
  }
}

/**
 * S·ª≠a phim
 */
function editMovie(movieId) {
  openMovieModal(movieId);
}

/**
 * X√≥a phim
 */
async function deleteMovie(movieId) {
  if (
    !confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a phim n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!")
  )
    return;

  if (!db) return;

  try {
    showLoading(true, "ƒêang x√≥a...");

    await db.collection("movies").doc(movieId).delete();

    showNotification("ƒê√£ x√≥a phim!", "success");

    // Reload data
    await loadMovies();
    await loadAdminMovies();
  } catch (error) {
    console.error("L·ªói x√≥a phim:", error);
    showNotification("Kh√¥ng th·ªÉ x√≥a phim!", "error");
  } finally {
    showLoading(false);
  }
}

// ============================================
// ADMIN CRUD - EPISODES
// ============================================

let selectedMovieForEpisodes = null;

/**
 * Populate movie select cho qu·∫£n l√Ω t·∫≠p
 */
function populateMovieSelect() {
  const select = document.getElementById("selectMovieForEpisodes");
  select.innerHTML =
    '<option value="">-- Ch·ªçn phim --</option>' +
    allMovies
      .map((m) => `<option value="${m.id}">${m.title}</option>`)
      .join("");
}

/**
 * Load t·∫≠p phim cho phim ƒë√£ ch·ªçn
 */
async function loadEpisodesForMovie() {
  const movieId = document.getElementById("selectMovieForEpisodes").value;
  const management = document.getElementById("episodesManagement");
  const tbody = document.getElementById("adminEpisodesTable");

  if (!movieId) {
    management.classList.add("hidden");
    return;
  }

  selectedMovieForEpisodes = movieId;
  management.classList.remove("hidden");

  const movie = allMovies.find((m) => m.id === movieId);
  const episodes = movie?.episodes || [];

  if (episodes.length === 0) {
    tbody.innerHTML =
      '<tr><td colspan="6" class="text-center">Ch∆∞a c√≥ t·∫≠p n√†o</td></tr>';
    return;
  }

  tbody.innerHTML = episodes
    .map(
      (ep, index) => `
        <tr>
            <td>${ep.episodeNumber}</td>
            <td>${ep.title || "N/A"}</td>
            <td>${ep.youtubeId}</td>
            <td>${ep.duration || "N/A"}</td>
            <td>${ep.quality || "HD"}</td>
            <td>
                <button class="btn btn-sm btn-secondary" onclick="editEpisode(${index})" title="S·ª≠a">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteEpisode(${index})" title="X√≥a">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `,
    )
    .join("");
}

/**
 * M·ªü modal th√™m/s·ª≠a t·∫≠p (ƒê√£ n√¢ng c·∫•p cho Phim L·∫ª)
 */
function openEpisodeModal(index = null) {
  const title = document.getElementById("episodeModalTitle");
  const form = document.getElementById("episodeForm");
  const epNumGroup = document.getElementById("episodeNumberGroup"); // L·∫•y c√°i khung nh·∫≠p s·ªë t·∫≠p

  // L·∫•y th√¥ng tin phim ƒëang ch·ªçn
  const movie = allMovies.find((m) => m.id === selectedMovieForEpisodes);
  const isSingle = movie && movie.type === "single"; // Ki·ªÉm tra xem c√≥ ph·∫£i phim l·∫ª kh√¥ng

  // X·ª¨ L√ù ·∫®N/HI·ªÜN √î NH·∫¨P S·ªê T·∫¨P
  if (isSingle) {
    epNumGroup.style.display = "none"; // N·∫øu l√† phim l·∫ª -> ·∫®n ƒëi
  } else {
    epNumGroup.style.display = "block"; // N·∫øu l√† phim b·ªô -> Hi·ªán l√™n
  }

  if (index !== null) {
    // --- CH·∫æ ƒê·ªò S·ª¨A (EDIT) ---
    title.textContent = isSingle ? "C·∫≠p Nh·∫≠t Link Phim" : "S·ª≠a T·∫≠p Phim";
    const episode = movie?.episodes?.[index];

    if (episode) {
      document.getElementById("episodeIndex").value = index;
      document.getElementById("episodeNumber").value = episode.episodeNumber;
      document.getElementById("episodeTitle").value = episode.title || "";
      document.getElementById("episodeYoutubeId").value = episode.youtubeId;
      document.getElementById("episodeDuration").value = episode.duration || "";
      document.getElementById("episodeQuality").value = episode.quality || "HD";
    }
  } else {
    // --- CH·∫æ ƒê·ªò TH√äM M·ªöI (ADD) ---
    title.textContent = isSingle ? "C·∫≠p Nh·∫≠t Link Phim" : "Th√™m T·∫≠p M·ªõi";
    form.reset();
    document.getElementById("episodeIndex").value = "";

    if (isSingle) {
      // N·∫øu l√† phim l·∫ª: T·ª± ƒëi·ªÅn T·∫≠p 1 v√† Ti√™u ƒë·ªÅ m·∫∑c ƒë·ªãnh
      document.getElementById("episodeNumber").value = 1;
      document.getElementById("episodeTitle").value = "Full Movie";
    } else {
      // N·∫øu l√† phim b·ªô: T·ª± t√≠nh t·∫≠p ti·∫øp theo
      const nextEp = (movie?.episodes?.length || 0) + 1;
      document.getElementById("episodeNumber").value = nextEp;
      document.getElementById("episodeTitle").value = "";
    }
  }

  openModal("episodeModal");
}

/**
 * X·ª≠ l√Ω submit form t·∫≠p phim
 */
async function handleEpisodeSubmit(event) {
  event.preventDefault();

  if (!db || !selectedMovieForEpisodes) return;

  const index = document.getElementById("episodeIndex").value;
  const episodeData = {
    episodeNumber: parseInt(document.getElementById("episodeNumber").value),
    title: document.getElementById("episodeTitle").value,
    youtubeId: document.getElementById("episodeYoutubeId").value,
    duration: document.getElementById("episodeDuration").value,
    quality: document.getElementById("episodeQuality").value,
  };

  try {
    showLoading(true, "ƒêang l∆∞u...");

    const movieRef = db.collection("movies").doc(selectedMovieForEpisodes);
    const movieDoc = await movieRef.get();
    let episodes = movieDoc.data()?.episodes || [];

    if (index !== "") {
      // Update
      episodes[parseInt(index)] = episodeData;
    } else {
      // Add
      episodes.push(episodeData);
    }

    // Sort by episode number
    episodes.sort((a, b) => a.episodeNumber - b.episodeNumber);

    await movieRef.update({ episodes });

    showNotification("ƒê√£ l∆∞u t·∫≠p phim!", "success");
    closeModal("episodeModal");

    // Reload
    await loadMovies();
    loadEpisodesForMovie();
  } catch (error) {
    console.error("L·ªói l∆∞u episode:", error);
    showNotification("Kh√¥ng th·ªÉ l∆∞u t·∫≠p phim!", "error");
  } finally {
    showLoading(false);
  }
}

/**
 * S·ª≠a t·∫≠p phim
 */
function editEpisode(index) {
  openEpisodeModal(index);
}

/**
 * X√≥a t·∫≠p phim
 */
async function deleteEpisode(index) {
  if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫≠p n√†y?")) return;

  if (!db || !selectedMovieForEpisodes) return;

  try {
    showLoading(true, "ƒêang x√≥a...");

    const movieRef = db.collection("movies").doc(selectedMovieForEpisodes);
    const movieDoc = await movieRef.get();
    let episodes = movieDoc.data()?.episodes || [];

    episodes.splice(index, 1);

    await movieRef.update({ episodes });

    showNotification("ƒê√£ x√≥a t·∫≠p phim!", "success");

    // Reload
    await loadMovies();
    loadEpisodesForMovie();
  } catch (error) {
    console.error("L·ªói x√≥a episode:", error);
    showNotification("Kh√¥ng th·ªÉ x√≥a t·∫≠p phim!", "error");
  } finally {
    showLoading(false);
  }
}

// ============================================
// ADMIN CRUD - CATEGORIES
// ============================================

/**
 * Render b·∫£ng th·ªÉ lo·∫°i
 */
function renderAdminCategories() {
  const tbody = document.getElementById("adminCategoriesTable");

  tbody.innerHTML = allCategories
    .map((cat) => {
      const movieCount = allMovies.filter(
        (m) => m.category === cat.name,
      ).length;
      return `
            <tr>
                <td>${cat.id}</td>
                <td>${cat.name}</td>
                <td>${cat.slug}</td>
                <td>${movieCount}</td>
                <td>
                    <button class="btn btn-sm btn-secondary" onclick="editCategory('${cat.id}')" title="S·ª≠a">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteCategory('${cat.id}')" title="X√≥a">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    })
    .join("");
}

/**
 * M·ªü modal th·ªÉ lo·∫°i
 */
function openCategoryModal(categoryId = null) {
  const form = document.getElementById("categoryForm");

  if (categoryId) {
    const cat = allCategories.find((c) => c.id === categoryId);
    if (cat) {
      document.getElementById("categoryId").value = categoryId;
      document.getElementById("categoryName").value = cat.name;
      document.getElementById("categorySlug").value = cat.slug;
    }
  } else {
    form.reset();
    document.getElementById("categoryId").value = "";
  }

  openModal("categoryModal");
}

/**
 * X·ª≠ l√Ω submit form th·ªÉ lo·∫°i
 */
async function handleCategorySubmit(event) {
  event.preventDefault();

  const categoryId = document.getElementById("categoryId").value;
  const name = document.getElementById("categoryName").value;
  let slug = document.getElementById("categorySlug").value;

  if (!slug) {
    slug = createSlug(name);
  }

  const categoryData = { name, slug };

  try {
    showLoading(true, "ƒêang l∆∞u...");

    if (db) {
      if (categoryId) {
        await db.collection("categories").doc(categoryId).update(categoryData);
      } else {
        const newId = createSlug(name);
        await db
          .collection("categories")
          .doc(newId)
          .set({ id: newId, ...categoryData });
      }
    }

    showNotification("ƒê√£ l∆∞u th·ªÉ lo·∫°i!", "success");
    closeModal("categoryModal");

    await loadCategories();
    renderAdminCategories();
    populateFilters();
  } catch (error) {
    console.error("L·ªói l∆∞u category:", error);
    showNotification("Kh√¥ng th·ªÉ l∆∞u th·ªÉ lo·∫°i!", "error");
  } finally {
    showLoading(false);
  }
}

/**
 * S·ª≠a th·ªÉ lo·∫°i
 */
function editCategory(categoryId) {
  openCategoryModal(categoryId);
}

/**
 * X√≥a th·ªÉ lo·∫°i
 */
async function deleteCategory(categoryId) {
  if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th·ªÉ lo·∫°i n√†y?")) return;

  try {
    if (db) {
      await db.collection("categories").doc(categoryId).delete();
    }

    showNotification("ƒê√£ x√≥a th·ªÉ lo·∫°i!", "success");

    await loadCategories();
    renderAdminCategories();
    populateFilters();
  } catch (error) {
    console.error("L·ªói x√≥a category:", error);
    showNotification("Kh√¥ng th·ªÉ x√≥a th·ªÉ lo·∫°i!", "error");
  }
}

// ============================================
// ADMIN CRUD - COUNTRIES
// ============================================

/**
 * Render b·∫£ng qu·ªëc gia
 */
function renderAdminCountries() {
  const tbody = document.getElementById("adminCountriesTable");

  tbody.innerHTML = allCountries
    .map((country) => {
      const movieCount = allMovies.filter(
        (m) => m.country === country.name,
      ).length;
      return `
            <tr>
                <td>${country.id}</td>
                <td>${country.name}</td>
                <td>${country.code}</td>
                <td>${movieCount}</td>
                <td>
                    <button class="btn btn-sm btn-secondary" onclick="editCountry('${country.id}')" title="S·ª≠a">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteCountry('${country.id}')" title="X√≥a">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    })
    .join("");
}

/**
 * M·ªü modal qu·ªëc gia
 */
function openCountryModal(countryId = null) {
  const form = document.getElementById("countryForm");

  if (countryId) {
    const country = allCountries.find((c) => c.id === countryId);
    if (country) {
      document.getElementById("countryId").value = countryId;
      document.getElementById("countryName").value = country.name;
      document.getElementById("countryCode").value = country.code;
    }
  } else {
    form.reset();
    document.getElementById("countryId").value = "";
  }

  openModal("countryModal");
}

/**
 * X·ª≠ l√Ω submit form qu·ªëc gia
 */
async function handleCountrySubmit(event) {
  event.preventDefault();

  const countryId = document.getElementById("countryId").value;
  const name = document.getElementById("countryName").value;
  const code = document.getElementById("countryCode").value.toUpperCase();

  const countryData = { name, code };

  try {
    showLoading(true, "ƒêang l∆∞u...");

    if (db) {
      if (countryId) {
        await db.collection("countries").doc(countryId).update(countryData);
      } else {
        const newId = code.toLowerCase();
        await db
          .collection("countries")
          .doc(newId)
          .set({ id: newId, ...countryData });
      }
    }

    showNotification("ƒê√£ l∆∞u qu·ªëc gia!", "success");
    closeModal("countryModal");

    await loadCountries();
    renderAdminCountries();
    populateFilters();
  } catch (error) {
    console.error("L·ªói l∆∞u country:", error);
    showNotification("Kh√¥ng th·ªÉ l∆∞u qu·ªëc gia!", "error");
  } finally {
    showLoading(false);
  }
}

/**
 * S·ª≠a qu·ªëc gia
 */
function editCountry(countryId) {
  openCountryModal(countryId);
}

/**
 * X√≥a qu·ªëc gia
 */
async function deleteCountry(countryId) {
  if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a qu·ªëc gia n√†y?")) return;

  try {
    if (db) {
      await db.collection("countries").doc(countryId).delete();
    }

    showNotification("ƒê√£ x√≥a qu·ªëc gia!", "success");

    await loadCountries();
    renderAdminCountries();
    populateFilters();
  } catch (error) {
    console.error("L·ªói x√≥a country:", error);
    showNotification("Kh√¥ng th·ªÉ x√≥a qu·ªëc gia!", "error");
  }
}

// ============================================
// ADMIN - USER MANAGEMENT
// ============================================

/**
 * M·ªü modal ph√¢n quy·ªÅn user
 */
function openUserRoleModal(userId, email, currentRole) {
  editingUserId = userId;
  document.getElementById("userRoleEmail").textContent = `Email: ${email}`;
  document.getElementById("userRoleSelect").value = currentRole || "user";
  openModal("userRoleModal");
}

/**
 * C·∫≠p nh·∫≠t role user
 */
async function updateUserRole() {
  if (!editingUserId || !db) return;

  const newRole = document.getElementById("userRoleSelect").value;

  try {
    showLoading(true, "ƒêang c·∫≠p nh·∫≠t...");

    await db.collection("users").doc(editingUserId).update({
      role: newRole,
    });

    showNotification("ƒê√£ c·∫≠p nh·∫≠t quy·ªÅn ng∆∞·ªùi d√πng!", "success");
    closeModal("userRoleModal");

    await loadAdminUsers();
  } catch (error) {
    console.error("L·ªói c·∫≠p nh·∫≠t role:", error);
    showNotification("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t quy·ªÅn!", "error");
  } finally {
    showLoading(false);
  }
}

/**
 * Kh√≥a/m·ªü kh√≥a user
 */
async function toggleUserStatus(userId, newStatus) {
  if (!db) return;

  const action = newStatus ? "m·ªü kh√≥a" : "kh√≥a";
  if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën ${action} t√†i kho·∫£n n√†y?`)) return;

  try {
    showLoading(true, "ƒêang c·∫≠p nh·∫≠t...");

    await db.collection("users").doc(userId).update({
      isActive: newStatus,
    });

    showNotification(`ƒê√£ ${action} t√†i kho·∫£n!`, "success");

    await loadAdminUsers();
  } catch (error) {
    console.error("L·ªói toggle user status:", error);
    showNotification("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i!", "error");
  } finally {
    showLoading(false);
  }
}
/**
 * X√≥a t√†i kho·∫£n ng∆∞·ªùi d√πng vƒ©nh vi·ªÖn
 */
async function deleteUser(userId, userEmail) {
  // 1. X√°c nh·∫≠n h√†nh ƒë·ªông (V√¨ x√≥a l√† m·∫•t lu√¥n)
  const confirmMsg = `‚ö†Ô∏è C·∫¢NH B√ÅO NGUY HI·ªÇM!\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA Vƒ®NH VI·ªÑN t√†i kho·∫£n: ${userEmail}?\n\nH√†nh ƒë·ªông n√†y s·∫Ω x√≥a to√†n b·ªô d·ªØ li·ªáu c·ªßa ng∆∞·ªùi d√πng n√†y kh·ªèi h·ªá th·ªëng v√† KH√îNG TH·ªÇ kh√¥i ph·ª•c.`;

  if (!confirm(confirmMsg)) return; // N·∫øu b·∫•m H·ªßy th√¨ d·ª´ng

  if (!db) return;

  try {
    showLoading(true, "ƒêang x√≥a t√†i kho·∫£n...");

    // ‚úÖ CODE M·ªöI: Ch·ªâ ƒë√°nh d·∫•u l√† ƒë√£ x√≥a (Soft Delete)
    // ƒê·ªÉ h·ªá th·ªëng c√≤n nh·∫≠n di·ªán ƒë∆∞·ª£c l√† "th·∫±ng n√†y ƒë√£ b·ªã x√≥a" m√† ch·∫∑n l·∫°i
    await db.collection("users").doc(userId).update({
      isDeleted: true, // C·ªù ƒë√°nh d·∫•u ƒë√£ x√≥a
      isActive: false, // Kh√≥a lu√¥n cho ch·∫Øc
      deletedAt: firebase.firestore.FieldValue.serverTimestamp(),
    });

    showNotification("ƒê√£ x√≥a t√†i kho·∫£n th√†nh c√¥ng!", "success");

    // T·∫£i l·∫°i b·∫£ng
    await loadAdminUsers();
    await loadAdminStats();
  } catch (error) {
    console.error("L·ªói x√≥a user:", error);
    showNotification("L·ªói: " + error.message, "error");
  } finally {
    showLoading(false);
  }
}
// ============================================
// UI FUNCTIONS
// ============================================

/**
 * Kh·ªüi t·∫°o UI
 */
function initializeUI() {
  // Close modals when clicking outside
  document.querySelectorAll(".modal-overlay").forEach((overlay) => {
    overlay.addEventListener("click", (e) => {
      if (e.target === overlay) {
        overlay.classList.remove("active");
      }
    });
  });

  // Close modals with Escape key
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      document.querySelectorAll(".modal-overlay.active").forEach((modal) => {
        modal.classList.remove("active");
      });
    }
  });
}

/**
 * Kh·ªüi t·∫°o rating stars
 */
function initializeRatingStars() {
  const container = document.getElementById("ratingStars");
  if (!container) return;

  container.innerHTML = "";
  for (let i = 1; i <= 10; i++) {
    const star = document.createElement("i");
    star.className = "fas fa-star";
    star.dataset.rating = i;
    star.addEventListener("click", () => setRating(i));
    star.addEventListener("mouseenter", () => highlightStars(i));
    star.addEventListener("mouseleave", () => highlightStars(selectedRating));
    container.appendChild(star);
  }
}

/**
 * Set rating
 */
function setRating(rating) {
  selectedRating = rating;
  updateRatingStars(rating);
  document.getElementById("ratingValue").textContent = `${rating}/10`;
}

/**
 * Highlight stars on hover
 */
function highlightStars(rating) {
  const stars = document.querySelectorAll("#ratingStars i");
  stars.forEach((star, index) => {
    star.classList.toggle("active", index < rating);
  });
}

/**
 * Update rating stars display
 */
function updateRatingStars(rating) {
  highlightStars(rating);
}

/**
 * Navbar scroll effect
 */
function initNavbarScroll() {
  const navbar = document.getElementById("navbar");

  window.addEventListener("scroll", () => {
    if (window.scrollY > 50) {
      navbar.classList.add("scrolled");
    } else {
      navbar.classList.remove("scrolled");
    }
  });
}

/**
 * Toggle mobile menu
 */
function toggleMobileMenu() {
  const menu = document.getElementById("navMenu");
  menu.classList.toggle("active");
}

/**
 * Toggle admin sidebar on mobile
 */
function toggleAdminSidebar() {
  const sidebar = document.getElementById("adminSidebar");
  sidebar.classList.toggle("active");
}

// ============================================
// THEME
// ============================================

/**
 * Load theme t·ª´ localStorage
 */
function loadTheme() {
  const savedTheme = localStorage.getItem("theme") || "dark";
  document.documentElement.setAttribute("data-theme", savedTheme);
  updateThemeIcon(savedTheme);
}

/**
 * Toggle theme
 */
function toggleTheme() {
  const currentTheme = document.documentElement.getAttribute("data-theme");
  const newTheme = currentTheme === "dark" ? "light" : "dark";

  document.documentElement.setAttribute("data-theme", newTheme);
  localStorage.setItem("theme", newTheme);
  updateThemeIcon(newTheme);
}

/**
 * Update theme icon
 */
function updateThemeIcon(theme) {
  const icon = document.getElementById("themeIcon");
  if (icon) {
    icon.className = theme === "dark" ? "fas fa-moon" : "fas fa-sun";
  }
}

// ============================================
// PAGE NAVIGATION
// ============================================

/**
 * Show page
 */
function showPage(pageName) {
  // Hide all pages
  document.querySelectorAll(".page").forEach((page) => {
    page.classList.remove("active");
  });

  // üëá TH√äM ƒêO·∫†N N√ÄY ƒê·ªÇ ·∫®N/HI·ªÜN N√öT 3 G·∫†CH üëá
  const sidebarBtn = document.getElementById("sidebarToggleBtn");
  if (sidebarBtn) {
    if (pageName === "admin") {
      sidebarBtn.style.display = "block"; // V√†o Admin th√¨ hi·ªán
    } else {
      sidebarBtn.style.display = "none"; // Ra trang kh√°c th√¨ ·∫©n
    }
  }

  // Show target page
  const targetPage = document.getElementById(`${pageName}Page`);
  if (targetPage) {
    targetPage.classList.add("active");
  }

  // Update nav links
  document.querySelectorAll(".nav-link").forEach((link) => {
    link.classList.remove("active");
    if (link.dataset.page === pageName) {
      link.classList.add("active");
    }
  });

  // Hide/show footer
  const footer = document.getElementById("footer");
  if (pageName === "admin") {
    footer.style.display = "none";
  } else {
    footer.style.display = "block";
  }

  // Close mobile menu
  document.getElementById("navMenu").classList.remove("active");

  // Scroll to top
  window.scrollTo(0, 0);

  // Load admin data if needed
  if (pageName === "admin" && isAdmin) {
    loadAdminData();
  }
}

/**
 * Show admin panel
 */
function showAdminPanel(panelName) {
  // Hide all panels
  document.querySelectorAll(".admin-panel").forEach((panel) => {
    panel.classList.remove("active");
  });

  // Show target panel
  const targetPanel = document.getElementById(`${panelName}Panel`);
  if (targetPanel) {
    targetPanel.classList.add("active");
  }

  // Update nav items
  document.querySelectorAll(".admin-nav-item").forEach((item) => {
    item.classList.remove("active");
    if (item.dataset.panel === panelName) {
      item.classList.add("active");
    }
  });
}

// ============================================
// MODALS
// ============================================

/**
 * Open modal
 */
function openModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.add("active");
  }
}

/**
 * Close modal
 */
function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.remove("active");
  }
}

/**
 * Open auth modal
 */
function openAuthModal() {
  openModal("authModal");
}

/**
 * Switch auth tab
 */
/**
 * Chuy·ªÉn ƒë·ªïi gi·ªØa c√°c tab Auth (Login / Register / Forgot)
 */
function switchAuthTab(tab) {
  // ·∫®n t·∫•t c·∫£ c√°c form tr∆∞·ªõc
  document.querySelectorAll(".auth-form").forEach((form) => {
    form.classList.remove("active");
  });

  // X·ª≠ l√Ω giao di·ªán Tab tr√™n ƒë·∫ßu (Login/Register)
  const tabsContainer = document.querySelector(".auth-tabs");

  if (tab === "forgot") {
    // N·∫øu l√† qu√™n m·∫≠t kh·∫©u -> ·∫®n lu√¥n c√°i thanh ch·ªçn Login/Register cho ƒë·∫πp
    tabsContainer.style.display = "none";
    document.getElementById("forgotForm").classList.add("active");
  } else {
    // N·∫øu l√† Login ho·∫∑c Register -> Hi·ªán l·∫°i thanh tab
    tabsContainer.style.display = "flex";
    document.getElementById(`${tab}Form`).classList.add("active");

    // Highlight c√°i tab ƒëang ch·ªçn
    document.querySelectorAll(".auth-tab").forEach((t) => {
      t.classList.toggle("active", t.dataset.tab === tab);
    });
  }
}

// ============================================
// SEARCH & FILTER
// ============================================

/**
 * Populate filter dropdowns
 */
function populateFilters() {
  // Categories
  const categoryFilter = document.getElementById("filterCategory");
  if (categoryFilter) {
    categoryFilter.innerHTML =
      '<option value="">T·∫•t c·∫£ th·ªÉ lo·∫°i</option>' +
      allCategories
        .map((c) => `<option value="${c.name}">${c.name}</option>`)
        .join("");
  }

  // Countries
  const countryFilter = document.getElementById("filterCountry");
  if (countryFilter) {
    countryFilter.innerHTML =
      '<option value="">T·∫•t c·∫£ qu·ªëc gia</option>' +
      allCountries
        .map((c) => `<option value="${c.name}">${c.name}</option>`)
        .join("");
  }

  // Years
  const yearFilter = document.getElementById("filterYear");
  if (yearFilter) {
    const years = [...new Set(allMovies.map((m) => m.year))].sort(
      (a, b) => b - a,
    );
    yearFilter.innerHTML =
      '<option value="">T·∫•t c·∫£ nƒÉm</option>' +
      years.map((y) => `<option value="${y}">${y}</option>`).join("");
  }
}

/**
 * Search movies
 */
function searchMovies() {
  const query = document.getElementById("searchMovies").value.toLowerCase();
  filterMovies(query);
}

/**
 * Filter movies
 */
function filterMovies(searchQuery = null) {
  const query =
    searchQuery !== null
      ? searchQuery
      : document.getElementById("searchMovies")?.value.toLowerCase() || "";
  const category = document.getElementById("filterCategory")?.value || "";
  const country = document.getElementById("filterCountry")?.value || "";
  const year = document.getElementById("filterYear")?.value || "";

  let filtered = allMovies.filter((movie) => {
    const matchQuery = !query || movie.title.toLowerCase().includes(query);
    const matchCategory = !category || movie.category === category;
    const matchCountry = !country || movie.country === country;
    const matchYear = !year || movie.year == year;

    return matchQuery && matchCategory && matchCountry && matchYear;
  });

  renderAllMovies(filtered);
}

// ============================================
// NOTIFICATIONS
// ============================================

/**
 * Show notification
 */
function showNotification(message, type = "info") {
  const container = document.getElementById("notificationContainer");

  const icons = {
    success: "fa-check-circle",
    error: "fa-times-circle",
    warning: "fa-exclamation-triangle",
    info: "fa-info-circle",
  };

  const notification = document.createElement("div");
  notification.className = `notification ${type}`;
  notification.innerHTML = `
        <i class="fas ${icons[type]}"></i>
        <div class="notification-content">${message}</div>
        <button class="notification-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;

  container.appendChild(notification);

  // Auto remove after 5 seconds
  setTimeout(() => {
    notification.style.animation = "slideIn 0.3s ease reverse";
    setTimeout(() => notification.remove(), 300);
  }, 5000);
}

// ============================================
// LOADING
// ============================================

/**
 * Show/hide loading overlay
 */
function showLoading(show, text = "ƒêang x·ª≠ l√Ω...") {
  const overlay = document.getElementById("loadingOverlay");
  const loadingText = document.getElementById("loadingText");

  if (show) {
    loadingText.textContent = text;
    overlay.classList.add("active");
  } else {
    overlay.classList.remove("active");
  }
}

/**
 * Show payment loading
 */
function showPaymentLoading(show) {
  showLoading(show, "ƒêang x·ª≠ l√Ω thanh to√°n...");
}

// ============================================
// UTILITY FUNCTIONS
// ============================================

/**
 * Format number with commas
 */
function formatNumber(num) {
  return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

/**
 * Format date
 */
function formatDate(date) {
  if (!date) return "N/A";
  return new Intl.DateTimeFormat("vi-VN", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
  }).format(date);
}

/**
 * Format time ago
 */
function formatTimeAgo(date) {
  const now = new Date();
  const diff = now - date;
  const seconds = Math.floor(diff / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);
  const days = Math.floor(hours / 24);

  if (days > 30) return formatDate(date);
  if (days > 0) return `${days} ng√†y tr∆∞·ªõc`;
  if (hours > 0) return `${hours} gi·ªù tr∆∞·ªõc`;
  if (minutes > 0) return `${minutes} ph√∫t tr∆∞·ªõc`;
  return "V·ª´a xong";
}

/**
 * Get status text
 */
function getStatusText(status) {
  const texts = {
    public: "C√¥ng khai",
    hidden: "·∫®n",
    pending: "Ch·ªù duy·ªát",
    completed: "Ho√†n th√†nh",
    failed: "Th·∫•t b·∫°i",
  };
  return texts[status] || status;
}

/**
 * Create slug from text
 */
function createSlug(text) {
  return text
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/ƒë/g, "d")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

/**
 * Escape HTML
 */
function escapeHtml(text) {
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}

// ============================================
// CATEGORIES PAGE
// ============================================

/**
 * Render categories page
 */
function renderCategoriesPage() {
  const container = document.getElementById("categoriesList");
  if (!container) return;

  container.innerHTML = allCategories
    .map((cat) => {
      const movieCount = allMovies.filter(
        (m) => m.category === cat.name,
      ).length;
      const randomMovie = allMovies.find((m) => m.category === cat.name);
      const bgImage =
        randomMovie?.posterUrl || "https://via.placeholder.com/300x200";

      return `
            <div class="card" onclick="filterByCategory('${cat.name}')" style="cursor:pointer;">
                <div class="card-image" style="padding-top: 60%;">
                    <img src="${bgImage}" alt="${cat.name}" loading="lazy">
                    <div class="card-overlay" style="opacity:1; background: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0.3));">
                        <div style="text-align:center; width:100%;">
                            <h3 style="margin:0;">${cat.name}</h3>
                            <p class="text-muted">${movieCount} phim</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    })
    .join("");
}

/**
 * Filter by category
 */
function filterByCategory(category) {
  showPage("movies");
  document.getElementById("filterCategory").value = category;
  filterMovies();
}

// Load categories page when showing
const originalShowPage = showPage;
showPage = function (pageName) {
  originalShowPage(pageName);
  if (pageName === "categories") {
    renderCategoriesPage();
  }
};

console.log("‚úÖ App.js loaded successfully!");

// H√†m b·∫≠t t·∫Øt Sidebar
function toggleSidebar() {
  const sidebar = document.getElementById("adminSidebar");
  const content = document.querySelector(".admin-content");

  // Th√™m ho·∫∑c b·ªè class 'collapsed' v√† 'expanded'
  sidebar.classList.toggle("collapsed");
  content.classList.toggle("expanded");
}

// ============================================
// PROFILE FUNCTIONS (TH√äM V√ÄO CU·ªêI FILE)
// ============================================
// ============================================
// PROFILE FUNCTIONS (PHI√äN B·∫¢N N√ÇNG C·∫§P: ƒê·ªîI T√äN + AVATAR)
// ============================================

// 1. M·ªü Modal v√† ƒëi·ªÅn d·ªØ li·ªáu c≈© v√†o √¥ nh·∫≠p
function openProfileModal() {
  if (!currentUser) return;

  // Hi·ªÉn th·ªã ·∫£nh v√† t√™n hi·ªán t·∫°i (Text tƒ©nh)
  document.getElementById("profileCurrentAvatar").src =
    currentUser.photoURL || "https://via.placeholder.com/100";
  document.getElementById("profileDisplayName").textContent =
    currentUser.displayName;
  document.getElementById("profileEmail").textContent = currentUser.email;

  // üëá ƒêI·ªÄN D·ªÆ LI·ªÜU C≈® V√ÄO √î NH·∫¨P (INPUT) ƒê·ªÇ S·ª¨A üëá
  document.getElementById("profileNameInput").value =
    currentUser.displayName || ""; // ƒêi·ªÅn t√™n c≈©
  document.getElementById("profileNewAvatar").value =
    currentUser.photoURL || ""; // ƒêi·ªÅn link ·∫£nh c≈©

  openModal("profileModal");
}

// 2. L∆∞u thay ƒë·ªïi (C·∫≠p nh·∫≠t c·∫£ T√™n v√† Avatar)
async function updateUserProfile() {
  const newName = document.getElementById("profileNameInput").value.trim();
  const newAvatar = document.getElementById("profileNewAvatar").value.trim();

  // Ki·ªÉm tra d·ªØ li·ªáu
  if (!newName) {
    showNotification("T√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!", "warning");
    return;
  }

  try {
    showLoading(true, "ƒêang c·∫≠p nh·∫≠t h·ªì s∆°...");

    // 1. C·∫≠p nh·∫≠t Firebase Auth (D·ªØ li·ªáu ƒëƒÉng nh·∫≠p)
    await currentUser.updateProfile({
      displayName: newName,
      photoURL: newAvatar,
    });

    // 2. C·∫≠p nh·∫≠t Firestore (D·ªØ li·ªáu ng∆∞·ªùi d√πng trong database)
    if (db) {
      await db.collection("users").doc(currentUser.uid).update({
        displayName: newName,
        avatar: newAvatar,
      });
    }

    showNotification("C·∫≠p nh·∫≠t h·ªì s∆° th√†nh c√¥ng!", "success");
    closeModal("profileModal");

    // 3. C·∫≠p nh·∫≠t giao di·ªán ngay l·∫≠p t·ª©c (Kh√¥ng c·∫ßn F5)
    updateAuthUI(true);
  } catch (error) {
    console.error("L·ªói c·∫≠p nh·∫≠t profile:", error);
    showNotification("L·ªói: " + error.message, "error");
  } finally {
    showLoading(false);
  }
}

/**
 * X·ª≠ l√Ω g·ª≠i email qu√™n m·∫≠t kh·∫©u
 */
async function handleForgotPassword(event) {
  event.preventDefault();

  const email = document.getElementById("forgotEmail").value.trim();

  if (!email) {
    showNotification("Vui l√≤ng nh·∫≠p email!", "warning");
    return;
  }

  try {
    showLoading(true, "ƒêang g·ª≠i email...");

    // G·ªçi h√†m c·ªßa Firebase
    await auth.sendPasswordResetEmail(email);

    // Th√¥ng b√°o th√†nh c√¥ng
    alert(
      "‚úÖ ƒê√£ g·ª≠i email kh√¥i ph·ª•c!\n\nVui l√≤ng ki·ªÉm tra h·ªôp th∆∞ (c·∫£ m·ª•c Spam) v√† l√†m theo h∆∞·ªõng d·∫´n trong email ƒë·ªÉ ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u.",
    );

    // Quay v·ªÅ trang ƒëƒÉng nh·∫≠p
    switchAuthTab("login");
  } catch (error) {
    console.error("L·ªói qu√™n m·∫≠t kh·∫©u:", error);
    let msg = "G·ª≠i th·∫•t b·∫°i!";

    if (error.code === "auth/user-not-found") {
      msg = "Email n√†y ch∆∞a ƒë∆∞·ª£c ƒëƒÉng k√Ω!";
    } else if (error.code === "auth/invalid-email") {
      msg = "Email kh√¥ng h·ª£p l·ªá!";
    }

    showNotification(msg, "error");
  } finally {
    showLoading(false);
  }
}

/**
 * ==========================================
 * T√åM KI·∫æM PHIM TRONG TAB QU·∫¢N L√ù T·∫¨P
 * ==========================================
 */
function filterEpisodeMovies() {
  // 1. L·∫•y t·ª´ kh√≥a ƒëang g√µ
  const query = document
    .getElementById("episodeMovieSearch")
    .value.toLowerCase();
  const select = document.getElementById("selectMovieForEpisodes");

  // Gi·ªØ l·∫°i gi√° tr·ªã ƒëang ch·ªçn (n·∫øu c√≥) ƒë·ªÉ kh√¥ng b·ªã m·∫•t khi l·ªçc
  const currentVal = select.value;

  // 2. L·ªçc danh s√°ch phim t·ª´ bi·∫øn to√†n c·ª•c allMovies
  // (N·∫øu kh√¥ng g√µ g√¨ th√¨ l·∫•y h·∫øt, g√µ th√¨ l·ªçc theo t√™n)
  const filteredMovies = allMovies.filter(
    (m) => !query || m.title.toLowerCase().includes(query),
  );

  // 3. T·∫°o l·∫°i HTML cho Dropdown
  let html = '<option value="">-- Ch·ªçn phim --</option>';

  if (filteredMovies.length === 0) {
    html += "<option disabled>Kh√¥ng t√¨m th·∫•y phim n√†o</option>";
  } else {
    html += filteredMovies
      .map((m) => `<option value="${m.id}">${m.title}</option>`)
      .join("");
  }

  // 4. C·∫≠p nh·∫≠t giao di·ªán
  select.innerHTML = html;

  // 5. C·ªë g·∫Øng kh√¥i ph·ª•c l·ª±a ch·ªçn c≈© n·∫øu n√≥ v·∫´n n·∫±m trong k·∫øt qu·∫£ l·ªçc
  select.value = currentVal;

  // N·∫øu phim ƒëang ch·ªçn b·ªã l·ªçc m·∫•t -> ·∫®n b·∫£ng t·∫≠p phim ƒëi cho ƒë·ª° r·ªëi
  if (!select.value) {
    document.getElementById("episodesManagement").classList.add("hidden");
  }
}
/**
 * L·ªçc phim theo Lo·∫°i (L·∫ª / B·ªô)
 */
function filterByMovieType(type) {
  // 1. Chuy·ªÉn sang trang danh s√°ch phim
  showPage("movies");

  // 2. C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ cho ng·∫ßu
  const titleMap = {
    single: "Danh s√°ch Phim L·∫ª",
    series: "Danh s√°ch Phim B·ªô",
  };
  document.querySelector("#moviesPage .section-title").textContent =
    titleMap[type] || "T·∫•t c·∫£ Phim";

  // 3. L·ªçc danh s√°ch
  const filtered = allMovies.filter((m) => m.type === type);

  // 4. Hi·ªÉn th·ªã ra m√†n h√¨nh
  renderAllMovies(filtered);

  // 5. Active menu (optional)
  // N·∫øu b·∫°n mu·ªën l√†m n√∫t menu s√°ng l√™n th√¨ c·∫ßn th√™m code x·ª≠ l√Ω class active ·ªü ƒë√¢y
}
// ============================================
// LOGIC Y√äU TH√çCH & L·ªäCH S·ª¨ (USER LIBRARY)
// ============================================
/**
 * H√†m x√≥a phim kh·ªèi danh s√°ch Y√™u th√≠ch (D√†nh ri√™ng cho Modal)
 */
async function removeFavoriteFromModal(movieId, btnElement) {
  // 1. G·ªçi h√†m toggle c≈© ƒë·ªÉ x·ª≠ l√Ω logic x√≥a trong Database
  await toggleFavorite(movieId);

  // 2. X·ª≠ l√Ω giao di·ªán: T√¨m c√°i th·∫ª ch·ª©a n√∫t b·∫•m v√† x√≥a n√≥ ƒëi
  const card = btnElement.closest(".card");

  if (card) {
    // T·∫°o hi·ªáu ·ª©ng m·ªù d·∫ßn v√† thu nh·ªè
    card.style.transition = "all 0.3s ease";
    card.style.opacity = "0";
    card.style.transform = "scale(0.8)";

    // ƒê·ª£i 0.3s cho hi·ªáu ·ª©ng ch·∫°y xong r·ªìi m·ªõi x√≥a h·∫≥n kh·ªèi HTML
    setTimeout(() => {
      card.remove();

      // Ki·ªÉm tra n·∫øu x√≥a h·∫øt s·∫°ch phim th√¨ hi·ªán th√¥ng b√°o tr·ªëng
      const container = document.getElementById("libraryList");
      if (container && container.children.length === 0) {
        container.innerHTML =
          '<p class="text-center text-muted">B·∫°n ch∆∞a th√≠ch phim n√†o.</p>';
      }
    }, 300);
  }
}
/**
 * 1. X·ª≠ l√Ω Th√≠ch/B·ªè th√≠ch phim
 */
async function toggleFavorite(movieId) {
  if (!currentUser) {
    showNotification("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u phim!", "warning");
    openAuthModal();
    return;
  }

  // Ki·ªÉm tra xem phim ƒë√£ c√≥ trong danh s√°ch ch∆∞a (d√πng m·∫£ng favorites trong currentUser)
  // L∆∞u √Ω: C·∫ßn ƒë·∫£m b·∫£o currentUser.favorites lu√¥n l√† m·∫£ng
  const favorites = currentUser.favorites || [];
  const isLiked = favorites.includes(movieId);

  // T√¨m n√∫t Like trong DOM ƒë·ªÉ ƒë·ªïi giao di·ªán ngay l·∫≠p t·ª©c (cho m∆∞·ª£t)
  const likeBtn = document.querySelector(`.btn-like-${movieId}`);

  try {
    let newFavorites;
    if (isLiked) {
      // N·∫øu ƒë√£ th√≠ch -> X√≥a kh·ªèi danh s√°ch
      newFavorites = favorites.filter((id) => id !== movieId);
      showNotification("ƒê√£ x√≥a kh·ªèi Y√™u th√≠ch", "info");
      if (likeBtn) {
        likeBtn.innerHTML = '<i class="far fa-heart"></i> Th√≠ch';
        likeBtn.classList.remove("liked");
        likeBtn.style.color = "#fff";
        likeBtn.style.borderColor = "rgba(255, 255, 255, 0.2)";
      }
    } else {
      // Ch∆∞a th√≠ch -> Th√™m v√†o danh s√°ch
      newFavorites = [...favorites, movieId];
      showNotification("ƒê√£ th√™m v√†o Y√™u th√≠ch ‚ù§Ô∏è", "success");
      if (likeBtn) {
        likeBtn.innerHTML = '<i class="fas fa-heart"></i> ƒê√£ th√≠ch';
        likeBtn.classList.add("liked");
        likeBtn.style.color = "#e50914"; // M√†u ƒë·ªè
        likeBtn.style.borderColor = "#e50914";
      }
    }

    // C·∫≠p nh·∫≠t Local State
    currentUser.favorites = newFavorites;

    // C·∫≠p nh·∫≠t Firestore
    if (db) {
      await db.collection("users").doc(currentUser.uid).update({
        favorites: newFavorites,
      });
    }
  } catch (error) {
    console.error("L·ªói c·∫≠p nh·∫≠t y√™u th√≠ch:", error);
  }
}

/**
 * 2. L∆∞u l·ªãch s·ª≠ xem (G·ªçi h√†m n√†y khi b·∫•m Xem phim ho·∫∑c ch·ªçn T·∫≠p)
 */
async function saveWatchHistory(movieId, episodeIndex) {
  if (!currentUser || !db) return;
  try {
    await db
      .collection("users")
      .doc(currentUser.uid)
      .collection("history")
      .doc(movieId)
      .set(
        {
          movieId: movieId,
          lastEpisode: episodeIndex,
          // D√πng serverTimestamp ƒë·ªÉ s·∫Øp x·∫øp phim n√†o m·ªõi xem l√™n ƒë·∫ßu
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastWatchedAt: firebase.firestore.FieldValue.serverTimestamp(),
        },
        { merge: true },
      );

    console.log(`‚úÖ ƒê√£ l∆∞u: Phim ${movieId} - T·∫≠p ${episodeIndex + 1}`);
  } catch (error) {
    console.error("L·ªói l∆∞u l·ªãch s·ª≠:", error);
  }
}

/**
 * 3. T·∫£i danh s√°ch phim (Y√™u th√≠ch ho·∫∑c L·ªãch s·ª≠) v√† hi·ªÉn th·ªã ra Modal
 */
// Thay th·∫ø h√†m openLibraryModal c≈© b·∫±ng h√†m n√†y
async function openLibraryModal(type) {
  if (!currentUser) return;

  const modalTitle = document.getElementById("libraryModalTitle");
  const container = document.getElementById("libraryList");
  container.innerHTML = '<div class="loading-spinner"></div>';

  openModal("libraryModal");

  let moviesToList = [];

  try {
    if (type === "favorites") {
      modalTitle.textContent = "Phim Y√™u Th√≠ch ‚ù§Ô∏è";
      const favIds = currentUser.favorites || [];
      moviesToList = allMovies.filter((m) => favIds.includes(m.id));
    } else if (type === "history") {
      modalTitle.textContent = "L·ªãch S·ª≠ ƒê√£ Xem üïí";
      if (db) {
        const snapshot = await db
          .collection("users")
          .doc(currentUser.uid)
          .collection("history")
          .orderBy("lastWatchedAt", "desc")
          .get();

        const historyData = snapshot.docs.map((doc) => doc.data());
        moviesToList = historyData
          .map((h) => {
            const movie = allMovies.find((m) => m.id === h.movieId);
            return movie ? { ...movie, _lastEpisode: h.lastEpisode } : null;
          })
          .filter((m) => m !== null);
      }
    }

    // --- RENDER GIAO DI·ªÜN ---
    if (moviesToList.length === 0) {
      container.innerHTML =
        '<p class="text-center text-muted">Danh s√°ch tr·ªëng.</p>';
    } else {
      container.innerHTML = moviesToList
        .map((movie) => {
          // üëá CODE M·ªöI: T·∫°o n√∫t X√≥a n·∫øu ƒëang ·ªü tab Y√™u th√≠ch üëá
          const removeBtn =
            type === "favorites"
              ? `<button class="btn-remove-fav" 
                       onclick="event.stopPropagation(); removeFavoriteFromModal('${movie.id}', this)" 
                       title="B·ªè y√™u th√≠ch">
                 <i class="fas fa-times"></i>
               </button>`
              : "";
          // üëÜ

          // Tag l·ªãch s·ª≠ xem
          const historyTag =
            type === "history" && movie._lastEpisode !== undefined
              ? `<div style="font-size:12px; color:#fcd535; margin-top:5px;">
                   <i class="fas fa-history"></i> ƒê√£ xem ƒë·∫øn T·∫≠p ${movie._lastEpisode + 1}
                 </div>`
              : "";

          return `
                <div class="card" onclick="viewMovieDetail('${movie.id}')">
                    <div class="card-image">
                        ${removeBtn}
                        
                        <img src="${movie.posterUrl}" loading="lazy">
                        <div class="card-overlay">
                            <button class="btn btn-primary"><i class="fas fa-play"></i></button>
                        </div>
                    </div>
                    <div class="card-body">
                        <h4 class="card-title">${movie.title}</h4>
                        ${historyTag}
                    </div>
                </div>`;
        })
        .join("");
    }
  } catch (error) {
    console.error("L·ªói t·∫£i th∆∞ vi·ªán:", error);
    container.innerHTML = '<p class="text-error">C√≥ l·ªói x·∫£y ra.</p>';
  }
}
/**
 * Ki·ªÉm tra xem VIP c√≤n h·∫°n kh√¥ng. N·∫øu h·∫øt h·∫°n -> H·∫° xu·ªëng Free
 */
async function checkAndDowngradeVip(user, userData) {
  if (!userData.isVip || !userData.vipExpiresAt) return; // Kh√¥ng ph·∫£i VIP ho·∫∑c VIP tr·ªçn ƒë·ªùi c≈© th√¨ b·ªè qua

  const expiryDate = userData.vipExpiresAt.toDate();
  const now = new Date();

  // N·∫øu Ng√†y h·∫øt h·∫°n nh·ªè h∆°n Ng√†y hi·ªán t·∫°i -> ƒê√£ h·∫øt h·∫°n
  if (expiryDate < now) {
    console.log("‚ö†Ô∏è VIP ƒë√£ h·∫øt h·∫°n! ƒêang h·∫° c·∫•p t√†i kho·∫£n...");

    try {
      // 1. C·∫≠p nh·∫≠t Firestore v·ªÅ Free
      await db.collection("users").doc(user.uid).update({
        isVip: false,
        vipExpiresAt: null,
      });

      // 2. C·∫≠p nh·∫≠t bi·∫øn c·ª•c b·ªô ƒë·ªÉ giao di·ªán ƒë·ªïi ngay l·∫≠p t·ª©c
      currentUser.isVip = false;

      // 3. Th√¥ng b√°o cho ng∆∞·ªùi d√πng bi·∫øt
      showNotification(
        "G√≥i VIP c·ªßa b·∫°n ƒë√£ h·∫øt h·∫°n. Vui l√≤ng gia h·∫°n ƒë·ªÉ ti·∫øp t·ª•c xem.",
        "warning",
      );
    } catch (error) {
      console.error("L·ªói t·ª± ƒë·ªông h·∫° c·∫•p VIP:", error);
    }
  }
}
